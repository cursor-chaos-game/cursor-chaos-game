<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <title>Chaos Runner - Premium Mobile Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            touch-action: none;
        }

        #gameCanvas {
            display: block;
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }

        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 200;
            overflow-y: auto;
            padding: 20px;
        }

        .screen h1 {
            font-size: clamp(36px, 8vw, 72px);
            margin-bottom: 20px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #f7b731);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease infinite;
            text-align: center;
        }

        @keyframes gradientShift {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(360deg); }
        }

        .subtitle {
            font-size: clamp(14px, 2.5vw, 20px);
            margin-bottom: 25px;
            color: #aaa;
            text-align: center;
        }

        .info-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 25px;
            margin: 8px 0;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            font-size: clamp(14px, 2.5vw, 18px);
            max-width: 90%;
            text-align: center;
        }

        .highlight {
            color: #ffd700;
            font-weight: bold;
        }

        button {
            margin: 10px;
            padding: 15px 40px;
            font-size: clamp(16px, 3.5vw, 24px);
            font-weight: bold;
            color: white;
            background: linear-gradient(45deg, #ff6b6b, #ee5a6f);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
            text-transform: uppercase;
            min-width: 180px;
        }

        button:active {
            transform: scale(0.95);
        }

        button.secondary {
            background: linear-gradient(45deg, #4ecdc4, #45b7d1);
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.4);
        }

        button.success {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.4);
        }

        button.premium {
            background: linear-gradient(45deg, #f7b731, #f39c12);
            box-shadow: 0 8px 25px rgba(247, 183, 49, 0.6);
            animation: premiumGlow 2s ease-in-out infinite;
        }

        @keyframes premiumGlow {
            0%, 100% { box-shadow: 0 8px 25px rgba(247, 183, 49, 0.6); }
            50% { box-shadow: 0 8px 35px rgba(247, 183, 49, 0.9); }
        }

        .button-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        #ui {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            font-size: clamp(16px, 3vw, 24px);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            z-index: 100;
            user-select: none;
        }

        #score {
            font-size: clamp(24px, 5vw, 36px);
            font-weight: bold;
            color: #ffd700;
        }

        .wave-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            font-size: clamp(18px, 4vw, 28px);
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        #pauseBtn, #musicBtn {
            position: fixed;
            width: 50px;
            height: 50px;
            min-width: unset;
            padding: 10px;
            font-size: 24px;
            z-index: 101;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #pauseBtn {
            top: 10px;
            right: 10px;
        }

        #musicBtn {
            top: 70px;
            right: 10px;
        }

        .shop-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin: 10px;
            border-radius: 15px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            width: 280px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .shop-item:hover {
            transform: translateY(-5px);
            border-color: #ffd700;
        }

        .shop-item.premium-item {
            border-color: #f7b731;
            background: linear-gradient(135deg, rgba(247, 183, 49, 0.2), rgba(243, 156, 18, 0.2));
            box-shadow: 0 0 20px rgba(247, 183, 49, 0.3);
        }

        .shop-item-icon {
            font-size: 64px;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
        }

        .shop-item-name {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #ffd700;
        }

        .premium-badge {
            display: inline-block;
            background: linear-gradient(45deg, #f7b731, #f39c12);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 8px;
            box-shadow: 0 0 10px rgba(247, 183, 49, 0.5);
        }

        .shop-item-desc {
            font-size: 14px;
            color: #ddd;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .shop-item-price {
            font-size: 20px;
            font-weight: bold;
            color: #4ecdc4;
            margin-bottom: 15px;
        }

        .shop-items-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 95%;
            max-height: 65vh;
            overflow-y: auto;
        }

        .skin-preview {
            width: 80px;
            height: 80px;
            margin: 10px auto;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            background: rgba(0, 0, 0, 0.3);
        }

        .owned-badge {
            background: #2ecc71;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            margin-top: 8px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(45deg, #4ecdc4, #45b7d1);
            border-color: #4ecdc4;
        }

        .leaderboard-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            margin: 8px 0;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 90%;
            max-width: 500px;
        }

        .rank-medal {
            font-size: 32px;
            margin-right: 15px;
        }

        .settings-option {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin: 10px 0;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-switch {
            width: 60px;
            height: 30px;
            background: #555;
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: #2ecc71;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            left: 32px;
        }

        @media (max-width: 768px) {
            .shop-item {
                width: 90%;
            }
        }

        /* Anti-cheat watermark */
        .watermark {
            position: fixed;
            bottom: 5px;
            right: 5px;
            font-size: 8px;
            color: rgba(255, 255, 255, 0.1);
            pointer-events: none;
            user-select: none;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <!-- Ana MenÃ¼ -->
    <div id="startScreen" class="screen">
        <h1>ğŸ® CHAOS RUNNER</h1>
        <div class="subtitle">KaranlÄ±ktan KaÃ§, IÅŸÄ±ÄŸÄ± Bul</div>
        
        <div class="info-box">
            ğŸ’ <span id="mainMenuCrystals">0</span> Kristal
        </div>

        <div class="button-row">
            <button onclick="startGame()">ğŸ® OYNA</button>
            <button class="secondary" onclick="openShop()">ğŸ›’ MAÄAZA</button>
        </div>

        <div class="button-row">
            <button class="secondary" onclick="openLeaderboard()">ğŸ† LIDERLER</button>
            <button class="secondary" onclick="openSettings()">âš™ï¸ AYARLAR</button>
        </div>

        <div class="info-box" style="margin-top: 20px;">
            <div>ğŸ† En YÃ¼ksek Dalga: <span id="highestWave">1</span></div>
            <div>ğŸ’° Toplam KazanÃ§: <span id="totalCrystals">0</span></div>
            <div style="margin-top: 10px; font-size: 14px; color: #888;">
                KostÃ¼m: <span id="currentSkinDisplay">ğŸ”µ Klasik</span>
            </div>
        </div>
    </div>

    <!-- MaÄŸaza -->
    <div id="shopScreen" class="screen" style="display: none;">
        <h1>ğŸ›’ MAÄAZA</h1>
        <div style="font-size: 24px; margin-bottom: 20px;">
            ğŸ’ <span id="shopCrystals">0</span> Kristal
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchShopTab('boosts')">âš¡ GÃ¼Ã§ler</div>
            <div class="tab" onclick="switchShopTab('skins')">ğŸ¨ KostÃ¼mler</div>
        </div>

        <!-- GÃ¼Ã§lendirmeler Sekmesi -->
        <div id="boostsTab" class="shop-items-grid">
            <div class="shop-item">
                <div class="shop-item-icon">ğŸ›¡ï¸</div>
                <div class="shop-item-name">BaÅŸlangÄ±Ã§ KalkanÄ±</div>
                <div class="shop-item-desc">Oyuna kalkan ile baÅŸla</div>
                <div class="shop-item-price">ğŸ’ 50</div>
                <button onclick="buyItem('startShield', 50)">SATIN AL</button>
            </div>

            <div class="shop-item">
                <div class="shop-item-icon">â¤ï¸</div>
                <div class="shop-item-name">Ekstra Can</div>
                <div class="shop-item-desc">+1 can ile baÅŸla</div>
                <div class="shop-item-price">ğŸ’ 75</div>
                <button onclick="buyItem('extraLife', 75)">SATIN AL</button>
            </div>

            <div class="shop-item">
                <div class="shop-item-icon">âš¡</div>
                <div class="shop-item-name">HÄ±z ArtÄ±ÅŸÄ±</div>
                <div class="shop-item-desc">%30 daha hÄ±zlÄ± koÅŸ</div>
                <div class="shop-item-price">ğŸ’ 100</div>
                <button onclick="buyItem('speedBoost', 100)">SATIN AL</button>
            </div>

            <div class="shop-item">
                <div class="shop-item-icon">ğŸ•</div>
                <div class="shop-item-name">Zaman KontrolÃ¼</div>
                <div class="shop-item-desc">Ä°lk 10 saniye dÃ¼ÅŸman yavaÅŸ</div>
                <div class="shop-item-price">ğŸ’ 80</div>
                <button onclick="buyItem('startSlow', 80)">SATIN AL</button>
            </div>

            <div class="shop-item">
                <div class="shop-item-icon">ğŸ§²</div>
                <div class="shop-item-name">Kristal MÄ±knatÄ±sÄ±</div>
                <div class="shop-item-desc">Otomatik toplama</div>
                <div class="shop-item-price">ğŸ’ 120</div>
                <button onclick="buyItem('magnetBoost', 120)">SATIN AL</button>
            </div>

            <div class="shop-item premium-item">
                <div class="premium-badge">â­ PREMIUM</div>
                <div class="shop-item-icon">ğŸ‘‘</div>
                <div class="shop-item-name">VIP Paketi</div>
                <div class="shop-item-desc">TÃ¼m gÃ¼Ã§ler + 3 premium kostÃ¼m</div>
                <div class="shop-item-price">ğŸ’ 500</div>
                <button class="premium" onclick="buyItem('vipPack', 500)">PREMIUM AL</button>
            </div>

            <div class="shop-item" style="border-color: #2ecc71;">
                <div class="shop-item-icon">ğŸ“º</div>
                <div class="shop-item-name">Ãœcretsiz Kristal</div>
                <div class="shop-item-desc">Reklam izle, 50 kristal kazan</div>
                <div class="shop-item-price">ğŸ ÃœCRETSÄ°Z</div>
                <button class="success" onclick="watchAd('crystals')">Ä°ZLE</button>
            </div>
        </div>

        <!-- KostÃ¼mler Sekmesi -->
        <div id="skinsTab" class="shop-items-grid" style="display: none;"></div>

        <button class="secondary" onclick="closeShop()" style="margin-top: 20px;">â—€ GERÄ°</button>
    </div>

    <!-- Liderlik Tablosu -->
    <div id="leaderboardScreen" class="screen" style="display: none;">
        <h1>ğŸ† LÄ°DERLÄ°K TABLOSU</h1>
        <div class="subtitle">En Ä°yi Oyuncular</div>

        <div id="leaderboardList" style="width: 100%; display: flex; flex-direction: column; align-items: center; max-height: 60vh; overflow-y: auto;">
            <!-- Dinamik olarak doldurulacak -->
        </div>

        <button class="secondary" onclick="closeLeaderboard()" style="margin-top: 20px;">â—€ GERÄ°</button>
    </div>

    <!-- Ayarlar -->
    <div id="settingsScreen" class="screen" style="display: none;">
        <h1>âš™ï¸ AYARLAR</h1>

        <div class="settings-option">
            <span>ğŸ”Š MÃ¼zik</span>
            <div class="toggle-switch" id="musicToggle" onclick="toggleMusic()"></div>
        </div>

        <div class="settings-option">
            <span>ğŸ”” Ses Efektleri</span>
            <div class="toggle-switch active" id="soundToggle" onclick="toggleSound()"></div>
        </div>

        <div class="settings-option">
            <span>ğŸ“³ TitreÅŸim</span>
            <div class="toggle-switch active" id="vibrationToggle" onclick="toggleVibration()"></div>
        </div>

        <div class="info-box" style="margin-top: 30px;">
            <div style="font-size: 16px; margin-bottom: 15px;">ğŸ“Š Ä°STATÄ°STÄ°KLER</div>
            <div>ğŸ® Toplam Oyun: <span id="totalGames">0</span></div>
            <div>â±ï¸ Toplam SÃ¼re: <span id="totalTime">0</span> dk</div>
            <div>ğŸ’ Toplam Kristal: <span id="totalCrystalsStats">0</span></div>
        </div>

        <button onclick="resetProgress()" style="background: linear-gradient(45deg, #e74c3c, #c0392b); margin-top: 20px;">ğŸ—‘ï¸ Ä°LERLEMEYÄ° SIL</button>

        <button class="secondary" onclick="closeSettings()" style="margin-top: 10px;">â—€ GERÄ°</button>
    </div>

    <!-- DiÄŸer ekranlar (Pause, GameOver, Ad) -->
    <div id="pauseScreen" class="screen" style="display: none;">
        <h1>â¸ï¸ DURAKLAMA</h1>
        <div class="info-box">
            <div>ğŸŒŠ Dalga: <span id="pauseWave">1</span></div>
            <div>ğŸ’¯ Skor: <span id="pauseScore">0</span></div>
        </div>
        <div class="button-row">
            <button class="success" onclick="resumeGame()">â–¶ï¸ DEVAM</button>
            <button class="secondary" onclick="restartFromPause()">ğŸ”„ YENÄ°DEN</button>
            <button onclick="quitToMenu()">ğŸ  MENÃœ</button>
        </div>
    </div>

    <div id="gameOverScreen" class="screen" style="display: none;">
        <h1>ğŸ’€ OYUN BÄ°TTÄ°</h1>
        <div class="info-box">
            <div style="font-size: 32px; color: #ffd700;">ğŸŒŠ Dalga: <span id="finalWave">0</span></div>
            <div style="font-size: 28px;">ğŸ’¯ Skor: <span id="finalScore">0</span></div>
            <div style="font-size: 24px; color: #4ecdc4;">ğŸ’ KazanÄ±lan: <span id="earnedCrystals">0</span></div>
        </div>
        <div class="info-box">ğŸ† En Ä°yi: Dalga <span id="bestWave">1</span></div>
        <div id="reviveOffer" class="info-box" style="background: rgba(46, 204, 113, 0.2); border: 2px solid #2ecc71;">
            <div style="font-size: 24px; margin-bottom: 15px;">â¤ï¸ DÄ°RÄ°L!</div>
            <div style="font-size: 16px; margin-bottom: 15px;">Reklam izle, devam et!</div>
            <button class="success" onclick="watchAd('revive')">ğŸ“º REKLAM Ä°ZLE</button>
        </div>
        <div class="button-row">
            <button onclick="restartGame()">ğŸ”„ TEKRAR</button>
            <button class="secondary" onclick="backToMenu()">ğŸ  MENÃœ</button>
        </div>
    </div>

    <div id="adScreen" class="screen" style="display: none;">
        <div style="background: rgba(0,0,0,0.9); padding: 40px; border-radius: 20px; text-align: center;">
            <h1>ğŸ“º REKLAM</h1>
            <div style="font-size: 18px; margin: 20px 0; color: #ddd;">
                Google AdMob reklamÄ± gÃ¶steriliyor...
            </div>
            <div style="font-size: 48px; color: #ffd700; margin: 20px 0;" id="adTimer">5</div>
            <div style="font-size: 16px; color: #aaa;">LÃ¼tfen bekleyin</div>
        </div>
    </div>

    <!-- Oyun UI -->
    <div id="ui" style="display: none;">
        <div>ğŸ’¯ <span id="score">0</span></div>
        <div style="font-size: 18px; margin-top: 5px;">â¤ï¸ <span id="health">â¤ï¸â¤ï¸â¤ï¸</span></div>
        <div style="font-size: 16px; margin-top: 5px;">ğŸ’ <span id="gameCrystals">0</span></div>
        <div id="shieldIndicator" style="display: none; margin-top: 5px; font-size: 16px;">ğŸ›¡ï¸</div>
    </div>

    <div class="wave-indicator" id="waveIndicator" style="display: none;">
        ğŸŒŠ <span id="wave">1</span>
    </div>

    <button id="pauseBtn" style="display: none;" onclick="pauseGame()">â¸ï¸</button>
    <button id="musicBtn" style="display: none;" onclick="toggleMusicInGame()">ğŸ”Š</button>

    <canvas id="gameCanvas"></canvas>

    <!-- Anti-cheat -->
    <div class="watermark" id="watermark"></div>

    <script>
        // ğŸ”’ GÃœVENLÄ°K KATMANI - Anti-Cheat & Protection
        (function() {
            'use strict';
            
            // Console korumasÄ±
            const devtools = {
                open: false,
                orientation: null
            };
            
            const threshold = 160;
            const emitEvent = (isOpen, orientation) => {
                window.dispatchEvent(new CustomEvent('devtoolschange', {
                    detail: { open: isOpen, orientation: orientation }
                }));
            };

            setInterval(() => {
                const widthThreshold = window.outerWidth - window.innerWidth > threshold;
                const heightThreshold = window.outerHeight - window.innerHeight > threshold;
                const orientation = widthThreshold ? 'vertical' : 'horizontal';

                if (!(heightThreshold && widthThreshold) && ((window.Firebug && window.Firebug.chrome && window.Firebug.chrome.isInitialized) || widthThreshold || heightThreshold)) {
                    if (!devtools.open || devtools.orientation !== orientation) {
                        emitEvent(true, orientation);
                        if (console && typeof console.clear === 'function') {
                            console.clear();
                        }
                    }
                    devtools.open = true;
                    devtools.orientation = orientation;
                } else {
                    if (devtools.open) {
                        emitEvent(false, null);
                    }
                    devtools.open = false;
                    devtools.orientation = null;
                }
            }, 500);

            // LocalStorage ÅŸifreleme
            const SECRET_KEY = btoa(Date.now().toString()).slice(0, 16);
            
            function encrypt(text) {
                return btoa(unescape(encodeURIComponent(text + SECRET_KEY)));
            }
            
            function decrypt(text) {
                try {
                    const decoded = decodeURIComponent(escape(atob(text)));
                    return decoded.replace(SECRET_KEY, '');
                } catch(e) {
                    return '0';
                }
            }

            // GÃ¼venli veri okuma/yazma
            window.secureStorage = {
                setItem: (key, value) => {
                    const encrypted = encrypt(value.toString());
                    localStorage.setItem(btoa(key), encrypted);
                },
                getItem: (key) => {
                    const encrypted = localStorage.getItem(btoa(key));
                    return encrypted ? decrypt(encrypted) : null;
                }
            };

            // Checksum doÄŸrulama
            window.validateGameState = () => {
                const crystals = parseInt(window.secureStorage.getItem('crystals') || '0');
                const totalCrystals = parseInt(window.secureStorage.getItem('totalCrystals') || '0');
                const highestWave = parseInt(window.secureStorage.getItem('highestWave') || '1');
                
                // Anormal deÄŸer kontrolÃ¼
                if (crystals > 99999 || totalCrystals > 999999 || highestWave > 1000) {
                    console.warn('Anormal deÄŸer tespit edildi, sÄ±fÄ±rlanÄ±yor...');
                    window.secureStorage.setItem('crystals', '0');
                    window.secureStorage.setItem('totalCrystals', '0');
                    window.secureStorage.setItem('highestWave', '1');
                    return false;
                }
                return true;
            };

            // Watermark
            const watermark = document.getElementById('watermark');
            setInterval(() => {
                watermark.textContent = `v1.0 | ${btoa(Date.now().toString()).slice(0, 8)}`;
            }, 1000);
        })();

        // ğŸµ MÃœZÄ°K SÄ°STEMÄ° - Procedural Music Generator
        class MusicGenerator {
            constructor() {
                this.audioContext = null;
                this.masterGain = null;
                this.isPlaying = false;
                this.currentOscillators = [];
                this.musicEnabled = true;
                
                // Melodic scale (Pentatonic for pleasant sound)
                this.scale = [261.63, 293.66, 329.63, 392.00, 440.00]; // C, D, E, G, A
                this.bassNotes = [130.81, 146.83, 164.81]; // C, D, E (lower octave)
            }

            init() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.masterGain = this.audioContext.createGain();
                this.masterGain.gain.value = 0.15; // Soft volume
                this.masterGain.connect(this.audioContext.destination);
            }

            start() {
                if (!this.musicEnabled || this.isPlaying) return;
                if (!this.audioContext) this.init();
                
                this.isPlaying = true;
                this.playAmbientLoop();
            }

            playAmbientLoop() {
                if (!this.isPlaying) return;

                // Bass line
                this.playNote(this.bassNotes[Math.floor(Math.random() * this.bassNotes.length)], 2, 'triangle', 0.1);

                // Melody
                setTimeout(() => {
                    if (this.isPlaying) {
                        this.playNote(this.scale[Math.floor(Math.random() * this.scale.length)], 0.5, 'sine', 0.15);
                    }
                }, 500);

                // Schedule next loop
                setTimeout(() => this.playAmbientLoop(), 3000);
            }

            playNote(frequency, duration, type = 'sine', volume = 0.3) {
                if (!this.audioContext || !this.musicEnabled) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.type = type;
                oscillator.frequency.value = frequency;

                gainNode.gain.value = volume;
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);

                oscillator.connect(gainNode);
                gainNode.connect(this.masterGain);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);

                this.currentOscillators.push(oscillator);
            }

            stop() {
                this.isPlaying = false;
                this.currentOscillators.forEach(osc => {
                    try { osc.stop(); } catch(e) {}
                });
                this.currentOscillators = [];
            }

            toggle() {
                this.musicEnabled = !this.musicEnabled;
                if (this.musicEnabled) {
                    this.start();
                } else {
                    this.stop();
                }
                return this.musicEnabled;
            }
        }

        const musicGen = new MusicGenerator();

        // ğŸ¨ KOSTÃœM SÄ°STEMÄ° - Premium Skins
        const SKINS = {
            classic: {
                id: 'classic',
                name: 'Klasik',
                icon: 'ğŸ”µ',
                color: '#4ecdc4',
                price: 0,
                rarity: 'common',
                description: 'BaÅŸlangÄ±Ã§ kostÃ¼mÃ¼'
            },
            fire: {
                id: 'fire',
                name: 'AteÅŸ Ruhu',
                icon: 'ğŸ”¥',
                color: '#ff4757',
                price: 150,
                rarity: 'rare',
                description: 'Alevlerden doÄŸan kahraman'
            },
            ice: {
                id: 'ice',
                name: 'Buz Prens',
                icon: 'â„ï¸',
                color: '#3498db',
                price: 150,
                rarity: 'rare',
                description: 'Donduran gÃ¼cÃ¼'
            },
            shadow: {
                id: 'shadow',
                name: 'GÃ¶lge SuikastÃ§Ä±',
                icon: 'ğŸŒ‘',
                color: '#2c3e50',
                price: 200,
                rarity: 'epic',
                description: 'KaranlÄ±kta gizlenen'
            },
            electric: {
                id: 'electric',
                name: 'Elektrik Åoku',
                icon: 'âš¡',
                color: '#f1c40f',
                price: 200,
                rarity: 'epic',
                description: 'YÄ±ldÄ±rÄ±m hÄ±zÄ±nda'
            },
            toxic: {
                id: 'toxic',
                name: 'Zehir Efendisi',
                icon: 'â˜¢ï¸',
                color: '#2ecc71',
                price: 250,
                rarity: 'epic',
                description: 'Ã–lÃ¼mcÃ¼l radyasyon'
            },
            galaxy: {
                id: 'galaxy',
                name: 'Galaksi Gezgini',
                icon: 'ğŸŒŒ',
                color: '#9b59b6',
                price: 400,
                rarity: 'legendary',
                description: 'Evrenleri aÅŸan gÃ¼Ã§'
            },
            phoenix: {
                id: 'phoenix',
                name: 'Anka KuÅŸu',
                icon: 'ğŸ¦…',
                color: '#e74c3c',
                price: 450,
                rarity: 'legendary',
                description: 'KÃ¼llerinden doÄŸan'
            },
            diamond: {
                id: 'diamond',
                name: 'Elmas ZÄ±rh',
                icon: 'ğŸ’',
                color: '#3498db',
                price: 500,
                rarity: 'legendary',
                description: 'KÄ±rÄ±lmaz kalkan'
            },
            dragon: {
                id: 'dragon',
                name: 'Ejderha Lordu',
                icon: 'ğŸ‰',
                color: '#c0392b',
                price: 800,
                rarity: 'mythic',
                description: 'Efsanevi gÃ¼Ã§'
            },
            angel: {
                id: 'angel',
                name: 'Melek SavaÅŸÃ§Ä±sÄ±',
                icon: 'ğŸ‘¼',
                color: '#ecf0f1',
                price: 800,
                rarity: 'mythic',
                description: 'Ä°lahi koruma'
            },
            demon: {
                id: 'demon',
                name: 'Ä°blis Efendisi',
                icon: 'ğŸ˜ˆ',
                color: '#8b0000',
                price: 900,
                rarity: 'mythic',
                description: 'KaranlÄ±ÄŸÄ±n gÃ¼cÃ¼'
            },
            cosmic: {
                id: 'cosmic',
                name: 'Kozmik VarlÄ±k',
                icon: 'ğŸŒ ',
                color: '#1abc9c',
                price: 1000,
                rarity: 'ultimate',
                description: 'Evrenin Ã¶zÃ¼ - EN GÃœÃ‡LÃœ'
            },
            rainbow: {
                id: 'rainbow',
                name: 'GÃ¶kkuÅŸaÄŸÄ± Efendisi',
                icon: 'ğŸŒˆ',
                color: '#ff6b6b',
                price: 1200,
                rarity: 'ultimate',
                description: 'TÃ¼m elementlerin hakimi'
            }
        };

        // OYUN DEÄÄ°ÅKENLERÄ°
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let gameState = 'menu';
        let gameRunning = false;
        let score = 0;
        let health = 3;
        let wave = 1;
        let crystals = parseInt(window.secureStorage.getItem('crystals') || '0');
        let totalCrystalsEarned = parseInt(window.secureStorage.getItem('totalCrystals') || '0');
        let highestWave = parseInt(window.secureStorage.getItem('highestWave') || '1');
        let totalGames = parseInt(window.secureStorage.getItem('totalGames') || '0');
        let totalPlayTime = parseInt(window.secureStorage.getItem('totalPlayTime') || '0');
        let gameCrystals = 0;
        let hasShield = false;
        let slowdownActive = false;
        let slowdownTimer = 0;
        let currentSkin = window.secureStorage.getItem('currentSkin') || 'classic';
        let ownedSkins = JSON.parse(window.secureStorage.getItem('ownedSkins') || '["classic"]');
        let musicEnabled = window.secureStorage.getItem('musicEnabled') !== 'false';
        let soundEnabled = window.secureStorage.getItem('soundEnabled') !== 'false';
        let vibrationEnabled = window.secureStorage.getItem('vibrationEnabled') !== 'false';
        let gameStartTime = 0;

        let purchasedBoosts = {
            startShield: false,
            extraLife: false,
            speedBoost: false,
            startSlow: false,
            magnetBoost: false
        };

        let activeBoosts = [];

        let player = {
            x: 0, y: 0,
            radius: 20,
            color: SKINS[currentSkin].color,
            baseSpeed: 6,
            speed: 6,
            targetX: 0,
            targetY: 0
        };

        let enemies = [];
        let stars = [];
        let powerups = [];
        let crystalDrops = [];
        let particles = [];

        const keys = {};
        document.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
        document.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);

        // Touch kontroller
        let touchStartX = 0, touchStartY = 0, isTouching = false;
        canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
        canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
        canvas.addEventListener('touchend', handleTouchEnd, { passive: false });

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            isTouching = true;
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!isTouching) return;
            const touch = e.touches[0];
            const deltaX = touch.clientX - touchStartX;
            const deltaY = touch.clientY - touchStartY;
            player.targetX += deltaX * 0.5;
            player.targetY += deltaY * 0.5;
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            isTouching = false;
        }

        // UI FONKSÄ°YONLARI
        function updateMainMenuUI() {
            window.validateGameState();
            document.getElementById('mainMenuCrystals').textContent = crystals;
            document.getElementById('highestWave').textContent = highestWave;
            document.getElementById('totalCrystals').textContent = totalCrystalsEarned;
            document.getElementById('currentSkinDisplay').textContent = `${SKINS[currentSkin].icon} ${SKINS[currentSkin].name}`;
        }

        function updateShopUI() {
            document.getElementById('shopCrystals').textContent = crystals;
        }

        function updateGameUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('wave').textContent = wave;
            document.getElementById('gameCrystals').textContent = gameCrystals;
            let healthDisplay = '';
            for (let i = 0; i < health; i++) healthDisplay += 'â¤ï¸';
            document.getElementById('health').textContent = healthDisplay || 'ğŸ’€';
            document.getElementById('shieldIndicator').style.display = hasShield ? 'block' : 'none';
        }

        // MAÄAZA FONKSÄ°YONLARI
        function openShop() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('shopScreen').style.display = 'flex';
            updateShopUI();
            switchShopTab('boosts');
        }

        function closeShop() {
            document.getElementById('shopScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
        }

        function switchShopTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'boosts') {
                document.getElementById('boostsTab').style.display = 'flex';
                document.getElementById('skinsTab').style.display = 'none';
            } else {
                document.getElementById('boostsTab').style.display = 'none';
                document.getElementById('skinsTab').style.display = 'flex';
                renderSkinsShop();
            }
        }

        function renderSkinsShop() {
            const skinsTab = document.getElementById('skinsTab');
            skinsTab.innerHTML = '';

            Object.values(SKINS).forEach(skin => {
                const owned = ownedSkins.includes(skin.id);
                const isCurrent = currentSkin === skin.id;

                const rarityColors = {
                    common: '#95a5a6',
                    rare: '#3498db',
                    epic: '#9b59b6',
                    legendary: '#f39c12',
                    mythic: '#e74c3c',
                    ultimate: '#1abc9c'
                };

                const item = document.createElement('div');
                item.className = 'shop-item';
                if (skin.rarity !== 'common') {
                    item.classList.add('premium-item');
                }
                item.style.borderColor = rarityColors[skin.rarity];

                item.innerHTML = `
                    ${skin.rarity !== 'common' ? `<div class="premium-badge" style="background: ${rarityColors[skin.rarity]}">â­ ${skin.rarity.toUpperCase()}</div>` : ''}
                    <div class="skin-preview" style="border-color: ${skin.color};">
                        <span style="font-size: 56px;">${skin.icon}</span>
                    </div>
                    <div class="shop-item-name">${skin.name}</div>
                    <div class="shop-item-desc">${skin.description}</div>
                    ${!owned ? `<div class="shop-item-price">ğŸ’ ${skin.price}</div>` : ''}
                    ${owned && !isCurrent ? '<div class="owned-badge">âœ“ SAHÄ°P</div>' : ''}
                    ${isCurrent ? '<div class="owned-badge" style="background: #f39c12;">â˜… AKTÄ°F</div>' : ''}
                    ${!owned ? `<button onclick="buySkin('${skin.id}', ${skin.price})"${crystals < skin.price ? ' disabled style="opacity: 0.5;"' : ''}>SATIN AL</button>` : ''}
                    ${owned && !isCurrent ? `<button class="success" onclick="equipSkin('${skin.id}')">GÄ°Y</button>` : ''}
                `;

                skinsTab.appendChild(item);
            });
        }

        function buyItem(itemType, cost) {
            if (crystals < cost) {
                alert('ğŸ’ Yetersiz kristal!');
                vibrate(200);
                return;
            }

            crystals -= cost;
            window.secureStorage.setItem('crystals', crystals.toString());
            purchasedBoosts[itemType] = true;

            if (itemType === 'vipPack') {
                // VIP paketi - tÃ¼m boostlar + premium skinler
                purchasedBoosts.startShield = true;
                purchasedBoosts.extraLife = true;
                purchasedBoosts.speedBoost = true;
                purchasedBoosts.startSlow = true;
                purchasedBoosts.magnetBoost = true;
                ['fire', 'ice', 'shadow'].forEach(skinId => {
                    if (!ownedSkins.includes(skinId)) {
                        ownedSkins.push(skinId);
                    }
                });
                window.secureStorage.setItem('ownedSkins', JSON.stringify(ownedSkins));
                alert('ğŸ‰ VIP Paketi satÄ±n alÄ±ndÄ±! TÃ¼m gÃ¼Ã§ler ve 3 premium kostÃ¼m aÃ§Ä±ldÄ±!');
            } else {
                alert('âœ… SatÄ±n alÄ±ndÄ±! Oyuna baÅŸladÄ±ÄŸÄ±nÄ±zda aktif olacak.');
            }

            playSound('powerup');
            vibrate(100);
            updateShopUI();
        }

        function buySkin(skinId, price) {
            if (crystals < price) {
                alert('ğŸ’ Yetersiz kristal!');
                vibrate(200);
                return;
            }

            crystals -= price;
            window.secureStorage.setItem('crystals', crystals.toString());
            ownedSkins.push(skinId);
            window.secureStorage.setItem('ownedSkins', JSON.stringify(ownedSkins));
            
            alert(`ğŸ‰ ${SKINS[skinId].name} satÄ±n alÄ±ndÄ±!`);
            playSound('powerup');
            vibrate(100);
            updateShopUI();
            renderSkinsShop();
        }

        function equipSkin(skinId) {
            currentSkin = skinId;
            player.color = SKINS[skinId].color;
            window.secureStorage.setItem('currentSkin', skinId);
            alert(`âœ¨ ${SKINS[skinId].name} giyildi!`);
            playSound('collect');
            renderSkinsShop();
            updateMainMenuUI();
        }

        // LÄ°DERLÄ°K TABLOSU
        function openLeaderboard() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('leaderboardScreen').style.display = 'flex';
            renderLeaderboard();
        }

        function closeLeaderboard() {
            document.getElementById('leaderboardScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
        }

        function renderLeaderboard() {
            const list = document.getElementById('leaderboardList');
            
            // SimÃ¼le edilmiÅŸ liderlik - gerÃ§ek uygulamada sunucudan gelir
            const leaders = [
                { name: 'Sen', wave: highestWave, score: totalCrystalsEarned },
                { name: 'ProGamer', wave: Math.max(highestWave + 5, 25), score: 15000 },
                { name: 'DragonSlayer', wave: Math.max(highestWave + 3, 20), score: 12000 },
                { name: 'ShadowNinja', wave: Math.max(highestWave + 2, 18), score: 10000 },
                { name: 'IceQueen', wave: Math.max(highestWave + 1, 15), score: 8500 }
            ].sort((a, b) => b.wave - a.wave);

            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'];

            list.innerHTML = leaders.map((leader, i) => `
                <div class="leaderboard-item" style="${leader.name === 'Sen' ? 'border: 2px solid #f39c12;' : ''}">
                    <span class="rank-medal">${medals[i]}</span>
                    <div style="flex: 1;">
                        <div style="font-size: 20px; font-weight: bold;">${leader.name}</div>
                        <div style="font-size: 14px; color: #aaa;">ğŸŒŠ Dalga ${leader.wave} | ğŸ’ ${leader.score}</div>
                    </div>
                </div>
            `).join('');
        }

        // AYARLAR
        function openSettings() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('settingsScreen').style.display = 'flex';
            
            document.getElementById('musicToggle').classList.toggle('active', musicEnabled);
            document.getElementById('soundToggle').classList.toggle('active', soundEnabled);
            document.getElementById('vibrationToggle').classList.toggle('active', vibrationEnabled);
            document.getElementById('totalGames').textContent = totalGames;
            document.getElementById('totalTime').textContent = Math.floor(totalPlayTime / 60);
            document.getElementById('totalCrystalsStats').textContent = totalCrystalsEarned;
        }

        function closeSettings() {
            document.getElementById('settingsScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
        }

        function toggleMusic() {
            musicEnabled = !musicEnabled;
            window.secureStorage.setItem('musicEnabled', musicEnabled.toString());
            document.getElementById('musicToggle').classList.toggle('active', musicEnabled);
            
            if (musicEnabled) {
                musicGen.start();
            } else {
                musicGen.stop();
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            window.secureStorage.setItem('soundEnabled', soundEnabled.toString());
            document.getElementById('soundToggle').classList.toggle('active', soundEnabled);
        }

        function toggleVibration() {
            vibrationEnabled = !vibrationEnabled;
            window.secureStorage.setItem('vibrationEnabled', vibrationEnabled.toString());
            document.getElementById('vibrationToggle').classList.toggle('active', vibrationEnabled);
            if (vibrationEnabled) vibrate(100);
        }

        function toggleMusicInGame() {
            const btn = document.getElementById('musicBtn');
            musicEnabled = musicGen.toggle();
            btn.textContent = musicEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
            window.secureStorage.setItem('musicEnabled', musicEnabled.toString());
        }

        function resetProgress() {
            if (!confirm('âš ï¸ TÃ¼m ilerleme silinecek! Emin misiniz?')) return;
            if (!confirm('â— SON UYARI! Bu iÅŸlem geri alÄ±namaz!')) return;

            localStorage.clear();
            location.reload();
        }

        // REKLAM SÄ°STEMÄ°
        let adCallback = null;

        function watchAd(type) {
            adCallback = type;
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('shopScreen').style.display = 'none';
            document.getElementById('adScreen').style.display = 'flex';

            let countdown = 5;
            document.getElementById('adTimer').textContent = countdown;

            const adInterval = setInterval(() => {
                countdown--;
                document.getElementById('adTimer').textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(adInterval);
                    finishAd();
                }
            }, 1000);
        }

        function finishAd() {
            document.getElementById('adScreen').style.display = 'none';

            if (adCallback === 'revive') {
                health = 2;
                hasShield = true;
                updateGameUI();
                document.getElementById('reviveOffer').style.display = 'none';
                resumeGame();
                playSound('powerup');
            } else if (adCallback === 'crystals') {
                crystals += 50;
                totalCrystalsEarned += 50;
                window.secureStorage.setItem('crystals', crystals.toString());
                window.secureStorage.setItem('totalCrystals', totalCrystalsEarned.toString());
                alert('ğŸ 50 Kristal kazandÄ±nÄ±z!');
                document.getElementById('shopScreen').style.display = 'flex';
                updateShopUI();
                playSound('collect');
            }

            adCallback = null;
        }

        // OYUN FONKSÄ°YONLARI
        function startGame() {
            gameState = 'playing';
            gameRunning = true;
            gameStartTime = Date.now();
            score = 0;
            health = 3;
            wave = 1;
            gameCrystals = 0;
            hasShield = false;
            slowdownActive = false;
            enemies = [];
            stars = [];
            powerups = [];
            crystalDrops = [];
            particles = [];
            activeBoosts = [];

            // SatÄ±n alÄ±nan boostlarÄ± uygula
            if (purchasedBoosts.startShield) {
                hasShield = true;
                activeBoosts.push({ name: 'Kalkan', icon: 'ğŸ›¡ï¸' });
                purchasedBoosts.startShield = false;
            }
            if (purchasedBoosts.extraLife) {
                health = 4;
                purchasedBoosts.extraLife = false;
            }
            if (purchasedBoosts.speedBoost) {
                player.speed = player.baseSpeed * 1.3;
                activeBoosts.push({ name: 'HÄ±z', icon: 'âš¡' });
            } else {
                player.speed = player.baseSpeed;
            }
            if (purchasedBoosts.startSlow) {
                slowdownActive = true;
                slowdownTimer = 600;
                activeBoosts.push({ name: 'YavaÅŸ', icon: 'ğŸ•' });
                purchasedBoosts.startSlow = false;
            }

            player.x = canvas.width / 2;
            player.y = canvas.height / 2;
            player.targetX = player.x;
            player.targetY = player.y;
            player.color = SKINS[currentSkin].color;

            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            document.getElementById('waveIndicator').style.display = 'block';
            document.getElementById('pauseBtn').style.display = 'flex';
            document.getElementById('musicBtn').style.display = 'flex';
            document.getElementById('musicBtn').textContent = musicEnabled ? 'ğŸ”Š' : 'ğŸ”‡';

            if (musicEnabled) musicGen.start();

            updateGameUI();
            spawnWave();
            gameLoop();
        }

        function spawnWave() {
            stars = [];
            powerups = [];

            const starCount = 3 + Math.floor(wave / 2);
            for (let i = 0; i < starCount; i++) {
                stars.push(createStar());
            }

            const enemyCount = Math.floor(1 + wave / 3);
            enemies = [];
            for (let i = 0; i < enemyCount; i++) {
                enemies.push(createEnemy());
            }

            if (wave >= 2 && Math.random() > 0.4) powerups.push(createPowerup('shield'));
            if (wave >= 3 && Math.random() > 0.5) powerups.push(createPowerup('health'));
            if (wave >= 4 && Math.random() > 0.5) powerups.push(createPowerup('slowdown'));
        }

        function createStar() {
            return {
                x: Math.random() * (canvas.width - 100) + 50,
                y: Math.random() * (canvas.height - 100) + 50,
                radius: 15,
                collected: false,
                pulsePhase: Math.random() * Math.PI * 2
            };
        }

        function createEnemy() {
            const types = ['normal', 'fast', 'tank'];
            const weights = wave < 5 ? [1, 0, 0] : wave < 10 ? [0.7, 0.3, 0] : [0.5, 0.3, 0.2];
            const rand = Math.random();
            let type = 'normal';

            if (rand < weights[2]) type = 'tank';
            else if (rand < weights[1] + weights[2]) type = 'fast';

            const baseSpeed = 2.5 + (wave * 0.35);

            let enemy = {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: 18,
                color: '#ff6b6b',
                baseSpeed: baseSpeed,
                speed: baseSpeed,
                angry: false,
                type: type
            };

            if (type === 'fast') {
                enemy.speed *= 1.5;
                enemy.radius = 14;
                enemy.color = '#ff9900';
            } else if (type === 'tank') {
                enemy.speed *= 0.7;
                enemy.radius = 24;
                enemy.color = '#8b0000';
            }

            return enemy;
        }

        function createPowerup(type) {
            return {
                x: Math.random() * (canvas.width - 100) + 50,
                y: Math.random() * (canvas.height - 100) + 50,
                radius: 18,
                type: type,
                collected: false,
                rotation: 0,
                pulse: 0,
                sparkle: 0
            };
        }

        function pauseGame() {
            if (gameState !== 'playing') return;
            gameState = 'paused';
            gameRunning = false;
            musicGen.stop();
            document.getElementById('pauseScreen').style.display = 'flex';
            document.getElementById('pauseWave').textContent = wave;
            document.getElementById('pauseScore').textContent = score;
        }

        function resumeGame() {
            gameState = 'playing';
            gameRunning = true;
            if (musicEnabled) musicGen.start();
            document.getElementById('pauseScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            gameLoop();
        }

        function restartFromPause() {
            document.getElementById('pauseScreen').style.display = 'none';
            restartGame();
        }

        function quitToMenu() {
            gameState = 'menu';
            gameRunning = false;
            musicGen.stop();
            document.getElementById('pauseScreen').style.display = 'none';
            document.getElementById('ui').style.display = 'none';
            document.getElementById('waveIndicator').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('musicBtn').style.display = 'none';
            backToMenu();
        }

        function restartGame() {
            document.getElementById('gameOverScreen').style.display = 'none';
            startGame();
        }

        function backToMenu() {
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('ui').style.display = 'none';
            document.getElementById('waveIndicator').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('musicBtn').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
            updateMainMenuUI();
        }

        function createParticles(x, y, color, count = 15) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 1,
                    color,
                    radius: Math.random() * 6 + 2
                });
            }
        }

        function checkCollision(obj1, obj2) {
            const dx = obj1.x - obj2.x;
            const dy = obj1.y - obj2.y;
            return Math.sqrt(dx * dx + dy * dy) < obj1.radius + obj2.radius;
        }

        function dropCrystals(x, y, amount) {
            for (let i = 0; i < amount; i++) {
                crystalDrops.push({
                    x: x + (Math.random() - 0.5) * 50,
                    y: y + (Math.random() - 0.5) * 50,
                    radius: 10,
                    value: 1,
                    collected: false,
                    sparkle: 0
                });
            }
        }

        function vibrate(duration) {
            if (vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(duration);
            }
        }

        // OYUN DÃ–NGÃœSÃœ
        function gameLoop() {
            if (!gameRunning) return;

            ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Oyuncu hareketi
            if (keys['w'] || keys['arrowup']) player.targetY -= player.speed;
            if (keys['s'] || keys['arrowdown']) player.targetY += player.speed;
            if (keys['a'] || keys['arrowleft']) player.targetX -= player.speed;
            if (keys['d'] || keys['arrowright']) player.targetX += player.speed;

            player.targetX = Math.max(player.radius, Math.min(canvas.width - player.radius, player.targetX));
            player.targetY = Math.max(player.radius, Math.min(canvas.height - player.radius, player.targetY));

            player.x += (player.targetX - player.x) * 0.15;
            player.y += (player.targetY - player.y) * 0.15;

            if (slowdownActive) {
                slowdownTimer--;
                if (slowdownTimer <= 0) {
                    slowdownActive = false;
                    activeBoosts = activeBoosts.filter(b => b.name !== 'YavaÅŸ');
                    updateGameUI();
                }
            }

            // DÃ¼ÅŸmanlarÄ± gÃ¼ncelle
            enemies.forEach(enemy => {
                const dx = player.x - enemy.x;
                const dy = player.y - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const angle = Math.atan2(dy, dx);

                let currentSpeed = enemy.speed;
                if (slowdownActive) currentSpeed *= 0.3;

                enemy.x += Math.cos(angle) * currentSpeed;
                enemy.y += Math.sin(angle) * currentSpeed;

                enemy.x = Math.max(enemy.radius, Math.min(canvas.width - enemy.radius, enemy.x));
                enemy.y = Math.max(enemy.radius, Math.min(canvas.height - enemy.radius, enemy.y));

                enemy.angry = distance < 100;

                // Ã‡iz
                ctx.save();
                ctx.translate(enemy.x, enemy.y);
                
                let scale = enemy.angry ? 1.2 + Math.sin(Date.now() * 0.02) * 0.1 : 1;
                ctx.scale(scale, scale);

                ctx.beginPath();
                ctx.arc(0, 0, enemy.radius, 0, Math.PI * 2);
                ctx.fillStyle = slowdownActive ? '#9b59b6' : (enemy.angry ? '#ff0000' : enemy.color);
                ctx.fill();

                const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, enemy.radius);
                gradient.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
                gradient.addColorStop(1, 'rgba(255, 107, 107, 0)');
                ctx.fillStyle = gradient;
                ctx.fill();

                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.fillStyle = 'white';
                ctx.fillRect(-6, -4, 4, 4);
                ctx.fillRect(2, -4, 4, 4);
                ctx.beginPath();
                ctx.arc(0, 4, 5, 0, Math.PI);
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.restore();

                // Ã‡arpÄ±ÅŸma
                if (checkCollision(player, enemy)) {
                    if (hasShield) {
                        hasShield = false;
                        activeBoosts = activeBoosts.filter(b => b.name !== 'Kalkan');
                        updateGameUI();
                        createParticles(player.x, player.y, '#64c8ff', 40);
                        playSound('shield');
                        vibrate(100);

                        const pushAngle = Math.atan2(enemy.y - player.y, enemy.x - player.x);
                        enemy.x += Math.cos(pushAngle) * 60;
                        enemy.y += Math.sin(pushAngle) * 60;
                    } else {
                        health--;
                        updateGameUI();
                        createParticles(player.x, player.y, '#ff6b6b', 40);
                        playSound('hit');
                        vibrate(200);

                        const pushAngle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
                        player.x += Math.cos(pushAngle) * 100;
                        player.y += Math.sin(pushAngle) * 100;
                        player.targetX = player.x;
                        player.targetY = player.y;

                        if (health <= 0) {
                            gameOver();
                            return;
                        }
                    }
                }
            });

            // Oyuncu Ã§iz
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
            ctx.fillStyle = player.color;
            ctx.fill();

            if (hasShield) {
                ctx.strokeStyle = 'rgba(100, 200, 255, 0.8)';
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.arc(player.x, player.y, player.radius + 8, 0, Math.PI * 2);
                ctx.stroke();
            }

            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.stroke();

            // Karakter ikonu
            ctx.font = `${player.radius * 1.5}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(SKINS[currentSkin].icon, player.x, player.y);

            // YÄ±ldÄ±zlar
            stars.forEach(star => {
                if (star.collected) return;

                star.pulsePhase += 0.1;
                const pulse = Math.sin(star.pulsePhase) * 3;

                ctx.save();
                ctx.translate(star.x, star.y);
                ctx.rotate(Date.now() * 0.003);
                ctx.fillStyle = '#ffd700';
                ctx.beginPath();
                for (let i = 0; i < 5; i++) {
                    const angle = (i * 4 * Math.PI) / 5 - Math.PI / 2;
                    const x = Math.cos(angle) * (star.radius + pulse);
                    const y = Math.sin(angle) * (star.radius + pulse);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fill();
                ctx.restore();

                if (checkCollision(player, star)) {
                    star.collected = true;
                    score += 10 * wave;
                    dropCrystals(star.x, star.y, 2 + wave);
                    updateGameUI();
                    createParticles(star.x, star.y, '#ffd700', 25);
                    playSound('collect');
                    vibrate(50);
                }
            });

            // Power-ups
            powerups.forEach(powerup => {
                if (powerup.collected) return;

                ctx.save();
                ctx.translate(powerup.x, powerup.y);

                if (powerup.type === 'shield') {
                    powerup.rotation += 0.05;
                    ctx.rotate(powerup.rotation);
                    ctx.strokeStyle = '#64c8ff';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.moveTo(0, -powerup.radius);
                    ctx.lineTo(-powerup.radius * 0.7, powerup.radius * 0.3);
                    ctx.lineTo(0, powerup.radius * 0.7);
                    ctx.lineTo(powerup.radius * 0.7, powerup.radius * 0.3);
                    ctx.closePath();
                    ctx.stroke();
                    ctx.fillStyle = 'rgba(100, 200, 255, 0.3)';
                    ctx.fill();
                } else if (powerup.type === 'health') {
                    powerup.pulse += 0.1;
                    const heartScale = 1 + Math.sin(powerup.pulse) * 0.2;
                    ctx.scale(heartScale, heartScale);
                    ctx.fillStyle = '#ff6b6b';
                    ctx.beginPath();
                    ctx.moveTo(0, 5);
                    ctx.bezierCurveTo(-10, -5, -15, 5, 0, 15);
                    ctx.bezierCurveTo(15, 5, 10, -5, 0, 5);
                    ctx.fill();
                } else if (powerup.type === 'slowdown') {
                    powerup.sparkle += 0.15;
                    ctx.rotate(powerup.sparkle);
                    ctx.fillStyle = '#f7b731';
                    ctx.shadowColor = '#f7b731';
                    ctx.shadowBlur = 20;
                    ctx.beginPath();
                    for (let i = 0; i < 8; i++) {
                        const angle = (i * Math.PI) / 4;
                        const radius = i % 2 === 0 ? powerup.radius : powerup.radius * 0.5;
                        const x = Math.cos(angle) * radius;
                        const y = Math.sin(angle) * radius;
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.closePath();
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }

                ctx.restore();

                if (checkCollision(player, powerup)) {
                    powerup.collected = true;
                    if (powerup.type === 'shield') {
                        hasShield = true;
                        if (!activeBoosts.find(b => b.name === 'Kalkan')) {
                            activeBoosts.push({ name: 'Kalkan', icon: 'ğŸ›¡ï¸' });
                        }
                    } else if (powerup.type === 'health') {
                        health = Math.min(health + 1, 5);
                    } else if (powerup.type === 'slowdown') {
                        slowdownActive = true;
                        slowdownTimer = 180;
                        if (!activeBoosts.find(b => b.name === 'YavaÅŸ')) {
                            activeBoosts.push({ name: 'YavaÅŸ', icon: 'ğŸ•' });
                        }
                    }
                    updateGameUI();
                    createParticles(powerup.x, powerup.y, powerup.type === 'shield' ? '#64c8ff' : powerup.type === 'health' ? '#ff6b6b' : '#f7b731', 30);
                    playSound('powerup');
                    vibrate(100);
                }
            });

            // Kristaller
            crystalDrops.forEach(crystal => {
                if (crystal.collected) return;

                crystal.sparkle += 0.2;

                ctx.save();
                ctx.translate(crystal.x, crystal.y);
                ctx.rotate(crystal.sparkle);
                ctx.fillStyle = '#4ecdc4';
                ctx.shadowColor = '#4ecdc4';
                ctx.shadowBlur = 15;
                ctx.beginPath();
                for (let i = 0; i < 6; i++) {
                    const angle = (i * Math.PI) / 3;
                    const radius = i % 2 === 0 ? crystal.radius : crystal.radius * 0.6;
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fill();
                ctx.shadowBlur = 0;
                ctx.restore();

                if (purchasedBoosts.magnetBoost) {
                    const dx = player.x - crystal.x;
                    const dy = player.y - crystal.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < 100) {
                        crystal.x += dx * 0.1;
                        crystal.y += dy * 0.1;
                    }
                }

                if (checkCollision(player, crystal)) {
                    crystal.collected = true;
                    gameCrystals += crystal.value;
                    updateGameUI();
                    playSound('collect');
                    vibrate(30);
                }
            });

            // ParÃ§acÄ±klar
            particles.forEach((p, index) => {
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.02;
                p.vy += 0.2;

                if (p.life <= 0) {
                    particles.splice(index, 1);
                    return;
                }

                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });

            // Dalga tamamlandÄ±
            if (stars.every(s => s.collected)) {
                wave++;
                updateGameUI();
                spawnWave();
                score += 50 * wave;
                updateGameUI();
                createParticles(canvas.width / 2, 100, '#4ecdc4', 50);
                playSound('powerup');
                vibrate(150);
            }

            requestAnimationFrame(gameLoop);
        }

        function gameOver() {
            gameRunning = false;
            gameState = 'gameover';
            musicGen.stop();

            // Oyun sÃ¼resini kaydet
            const playTime = Math.floor((Date.now() - gameStartTime) / 1000);
            totalPlayTime += playTime;
            totalGames++;
            window.secureStorage.setItem('totalPlayTime', totalPlayTime.toString());
            window.secureStorage.setItem('totalGames', totalGames.toString());

            // Kristalleri kaydet
            crystals += gameCrystals;
            totalCrystalsEarned += gameCrystals;
            window.secureStorage.setItem('crystals', crystals.toString());
            window.secureStorage.setItem('totalCrystals', totalCrystalsEarned.toString());

            // En yÃ¼ksek dalga
            if (wave > highestWave) {
                highestWave = wave;
                window.secureStorage.setItem('highestWave', highestWave.toString());
            }

            document.getElementById('ui').style.display = 'none';
            document.getElementById('waveIndicator').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('musicBtn').style.display = 'none';
            document.getElementById('finalWave').textContent = wave;
            document.getElementById('finalScore').textContent = score;
            document.getElementById('earnedCrystals').textContent = gameCrystals;
            document.getElementById('bestWave').textContent = highestWave;
            document.getElementById('gameOverScreen').style.display = 'flex';

            vibrate([100, 50, 100, 50, 200]);
        }

        // SES SÄ°STEMÄ°
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (!soundEnabled) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            if (type === 'collect') {
                oscillator.frequency.value = 800;
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } else if (type === 'hit') {
                oscillator.frequency.value = 150;
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } else if (type === 'powerup') {
                oscillator.frequency.value = 1000;
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } else if (type === 'shield') {
                oscillator.frequency.value = 600;
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);
            }
        }

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // BaÅŸlangÄ±Ã§
        updateMainMenuUI();
        if (musicEnabled) musicGen.start();
    </script>
</body>
</html>
                
