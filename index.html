<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <title>Chaos Runner - Premium Mobile Game</title>
    <style>
        /* ... (stil aynÄ±, uzunluk yÃ¼zÃ¼nden kÄ±saltÄ±lmadÄ± - orijinali kullan) ... */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); touch-action: none; }
        #gameCanvas { display: block; background: rgba(0, 0, 0, 0.3); box-shadow: 0 0 50px rgba(0, 0, 0, 0.5); }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 200; overflow-y: auto; padding: 20px; }
        .screen h1 { font-size: clamp(36px, 8vw, 72px); margin-bottom: 20px; background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #f7b731); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: gradientShift 3s ease infinite; text-align: center; }
        @keyframes gradientShift { 0%, 100% { filter: hue-rotate(0deg); } 50% { filter: hue-rotate(360deg); } }
        .subtitle { font-size: clamp(14px, 2.5vw, 20px); margin-bottom: 25px; color: #aaa; text-align: center; }
        .info-box { background: rgba(255, 255, 255, 0.1); padding: 15px 25px; margin: 8px 0; border-radius: 12px; backdrop-filter: blur(10px); font-size: clamp(14px, 2.5vw, 18px); max-width: 90%; text-align: center; }
        button { margin: 10px; padding: 15px 40px; font-size: clamp(16px, 3.5vw, 24px); font-weight: bold; color: white; background: linear-gradient(45deg, #ff6b6b, #ee5a6f); border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4); transition: all 0.3s ease; text-transform: uppercase; min-width: 180px; }
        button:active { transform: scale(0.95); }
        button.secondary { background: linear-gradient(45deg, #4ecdc4, #45b7d1); box-shadow: 0 8px 25px rgba(78, 205, 196, 0.4); }
        button.success { background: linear-gradient(45deg, #2ecc71, #27ae60); box-shadow: 0 8px 25px rgba(46, 204, 113, 0.4); }
        button.premium { background: linear-gradient(45deg, #f7b731, #f39c12); box-shadow: 0 8px 25px rgba(247, 183, 49, 0.6); animation: premiumGlow 2s ease-in-out infinite; }
        @keyframes premiumGlow { 0%, 100% { box-shadow: 0 8px 25px rgba(247, 183, 49, 0.6); } 50% { box-shadow: 0 8px 35px rgba(247, 183, 49, 0.9); } }
        .button-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        #ui { position: fixed; top: 10px; left: 10px; color: white; font-size: clamp(16px, 3vw, 24px); text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); z-index: 100; user-select: none; }
        #score { font-size: clamp(24px, 5vw, 36px); font-weight: bold; color: #ffd700; }
        .wave-indicator { position: fixed; top: 10px; right: 10px; font-size: clamp(18px, 4vw, 28px); color: white; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); padding: 12px 20px; background: rgba(0, 0, 0, 0.6); border-radius: 15px; backdrop-filter: blur(10px); }
        #pauseBtn, #musicBtn { position: fixed; width: 50px; height: 50px; min-width: unset; padding: 10px; font-size: 24px; z-index: 101; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        #pauseBtn { top: 10px; right: 10px; }
        #musicBtn { top: 70px; right: 10px; }
        .shop-item { background: rgba(255, 255, 255, 0.1); padding: 20px; margin: 10px; border-radius: 15px; border: 3px solid rgba(255, 255, 255, 0.3); width: 280px; text-align: center; transition: all 0.3s ease; }
        .shop-item.premium-item { border-color: #f7b731; background: linear-gradient(135deg, rgba(247, 183, 49, 0.2), rgba(243, 156, 18, 0.2)); box-shadow: 0 0 20px rgba(247, 183, 49, 0.3); }
        .shop-item-icon { font-size: 64px; margin-bottom: 15px; filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5)); }
        .shop-items-grid { display: flex; flex-wrap: wrap; justify-content: center; max-width: 95%; max-height: 65vh; overflow-y: auto; }
        .skin-preview { width: 80px; height: 80px; margin: 10px auto; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px; border: 3px solid rgba(255, 255, 255, 0.3); background: rgba(0, 0, 0, 0.3); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 12px 24px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 25px; cursor: pointer; transition: all 0.3s; }
        .tab.active { background: linear-gradient(45deg, #4ecdc4, #45b7d1); border-color: #4ecdc4; }
        .leaderboard-item { background: rgba(255, 255, 255, 0.1); padding: 15px 20px; margin: 8px 0; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; width: 90%; max-width: 500px; }
        .settings-option { background: rgba(255, 255, 255, 0.1); padding: 20px; margin: 10px 0; border-radius: 12px; width: 90%; max-width: 400px; display: flex; justify-content: space-between; align-items: center; }
        .toggle-switch { width: 60px; height: 30px; background: #555; border-radius: 15px; position: relative; cursor: pointer; transition: all 0.3s; }
        .toggle-switch.active { background: #2ecc71; }
        .toggle-switch::after { content: ''; position: absolute; width: 26px; height: 26px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: all 0.3s; }
        .toggle-switch.active::after { left: 32px; }
        @media (max-width: 768px) { .shop-item { width: 90%; } }
        .watermark { position: fixed; bottom: 5px; right: 5px; font-size: 8px; color: rgba(255, 255, 255, 0.1); pointer-events: none; user-select: none; z-index: 9999; }
    </style>
</head>
<body>
    <!-- (HTML ekranlarÄ±: aynen korunuyor) -->
    <div id="startScreen" class="screen">
        <h1>ğŸ® CHAOS RUNNER</h1>
        <div class="subtitle">KaranlÄ±ktan KaÃ§, IÅŸÄ±ÄŸÄ± Bul</div>
        <div class="info-box">ğŸ’ <span id="mainMenuCrystals">0</span> Kristal</div>
        <div class="button-row">
            <button onclick="startGame()">ğŸ® OYNA</button>
            <button class="secondary" onclick="openShop()">ğŸ›’ MAÄAZA</button>
        </div>
        <div class="button-row">
            <button class="secondary" onclick="openLeaderboard()">ğŸ† LIDERLER</button>
            <button class="secondary" onclick="openSettings()">âš™ï¸ AYARLAR</button>
        </div>
        <div class="info-box" style="margin-top: 20px;">
            <div>ğŸ† En YÃ¼ksek Dalga: <span id="highestWave">1</span></div>
            <div>ğŸ’° Toplam KazanÃ§: <span id="totalCrystals">0</span></div>
            <div style="margin-top: 10px; font-size: 14px; color: #888;">KostÃ¼m: <span id="currentSkinDisplay">ğŸ”µ Klasik</span></div>
        </div>
    </div>

    <div id="shopScreen" class="screen" style="display: none;">
        <h1>ğŸ›’ MAÄAZA</h1>
        <div style="font-size: 24px; margin-bottom: 20px;">ğŸ’ <span id="shopCrystals">0</span> Kristal</div>
        <div class="tabs">
            <div class="tab active" id="tab-boosts" onclick="switchShopTab('boosts')">âš¡ GÃ¼Ã§ler</div>
            <div class="tab" id="tab-skins" onclick="switchShopTab('skins')">ğŸ¨ KostÃ¼mler</div>
        </div>
        <div id="boostsTab" class="shop-items-grid">
            <!-- boost itemler aynÄ± -->
            <div class="shop-item"><div class="shop-item-icon">ğŸ›¡ï¸</div><div class="shop-item-name">BaÅŸlangÄ±Ã§ KalkanÄ±</div><div class="shop-item-desc">Oyuna kalkan ile baÅŸla</div><div class="shop-item-price">ğŸ’ 50</div><button onclick="buyItem('startShield', 50)">SATIN AL</button></div>
            <div class="shop-item"><div class="shop-item-icon">â¤ï¸</div><div class="shop-item-name">Ekstra Can</div><div class="shop-item-desc">+1 can ile baÅŸla</div><div class="shop-item-price">ğŸ’ 75</div><button onclick="buyItem('extraLife', 75)">SATIN AL</button></div>
            <div class="shop-item"><div class="shop-item-icon">âš¡</div><div class="shop-item-name">HÄ±z ArtÄ±ÅŸÄ±</div><div class="shop-item-desc">%30 daha hÄ±zlÄ± koÅŸ</div><div class="shop-item-price">ğŸ’ 100</div><button onclick="buyItem('speedBoost', 100)">SATIN AL</button></div>
            <div class="shop-item"><div class="shop-item-icon">ğŸ•</div><div class="shop-item-name">Zaman KontrolÃ¼</div><div class="shop-item-desc">Ä°lk 10 saniye dÃ¼ÅŸman yavaÅŸ</div><div class="shop-item-price">ğŸ’ 80</div><button onclick="buyItem('startSlow', 80)">SATIN AL</button></div>
            <div class="shop-item"><div class="shop-item-icon">ğŸ§²</div><div class="shop-item-name">Kristal MÄ±knatÄ±sÄ±</div><div class="shop-item-desc">Otomatik toplama</div><div class="shop-item-price">ğŸ’ 120</div><button onclick="buyItem('magnetBoost', 120)">SATIN AL</button></div>
            <div class="shop-item premium-item"><div class="premium-badge">â­ PREMIUM</div><div class="shop-item-icon">ğŸ‘‘</div><div class="shop-item-name">VIP Paketi</div><div class="shop-item-desc">TÃ¼m gÃ¼Ã§ler + 3 premium kostÃ¼m</div><div class="shop-item-price">ğŸ’ 500</div><button class="premium" onclick="buyItem('vipPack', 500)">PREMIUM AL</button></div>
            <div class="shop-item" style="border-color: #2ecc71;"><div class="shop-item-icon">ğŸ“º</div><div class="shop-item-name">Ãœcretsiz Kristal</div><div class="shop-item-desc">Reklam izle, 50 kristal kazan</div><div class="shop-item-price">ğŸ ÃœCRETSÄ°Z</div><button class="success" onclick="watchAd('crystals')">Ä°ZLE</button></div>
        </div>
        <div id="skinsTab" class="shop-items-grid" style="display: none;"></div>
        <button class="secondary" onclick="closeShop()" style="margin-top: 20px;">â—€ GERÄ°</button>
    </div>

    <div id="leaderboardScreen" class="screen" style="display: none;">
        <h1>ğŸ† LÄ°DERLÄ°K TABLOSU</h1>
        <div class="subtitle">En Ä°yi Oyuncular</div>
        <div id="leaderboardList" style="width: 100%; display: flex; flex-direction: column; align-items: center; max-height: 60vh; overflow-y: auto;"></div>
        <button class="secondary" onclick="closeLeaderboard()" style="margin-top: 20px;">â—€ GERÄ°</button>
    </div>

    <div id="settingsScreen" class="screen" style="display: none;">
        <h1>âš™ï¸ AYARLAR</h1>
        <div class="settings-option"><span>ğŸ”Š MÃ¼zik</span><div class="toggle-switch" id="musicToggle" onclick="toggleMusic()"></div></div>
        <div class="settings-option"><span>ğŸ”” Ses Efektleri</span><div class="toggle-switch active" id="soundToggle" onclick="toggleSound()"></div></div>
        <div class="settings-option"><span>ğŸ“³ TitreÅŸim</span><div class="toggle-switch active" id="vibrationToggle" onclick="toggleVibration()"></div></div>
        <div class="info-box" style="margin-top: 30px;">
            <div style="font-size: 16px; margin-bottom: 15px;">ğŸ“Š Ä°STATÄ°STÄ°KLER</div>
            <div>ğŸ® Toplam Oyun: <span id="totalGames">0</span></div>
            <div>â±ï¸ Toplam SÃ¼re: <span id="totalTime">0</span> dk</div>
            <div>ğŸ’ Toplam Kristal: <span id="totalCrystalsStats">0</span></div>
        </div>
        <button onclick="resetProgress()" style="background: linear-gradient(45deg, #e74c3c, #c0392b); margin-top: 20px;">ğŸ—‘ï¸ Ä°LERLEMEYÄ° SIL</button>
        <button class="secondary" onclick="closeSettings()" style="margin-top: 10px;">â—€ GERÄ°</button>
    </div>

    <div id="pauseScreen" class="screen" style="display: none;">
        <h1>â¸ï¸ DURAKLAMA</h1>
        <div class="info-box"><div>ğŸŒŠ Dalga: <span id="pauseWave">1</span></div><div>ğŸ’¯ Skor: <span id="pauseScore">0</span></div></div>
        <div class="button-row">
            <button class="success" onclick="resumeFromPause()">â–¶ï¸ DEVAM</button>
            <button class="secondary" onclick="restartFromPause()">ğŸ”„ YENÄ°DEN</button>
            <button onclick="quitToMenu()">ğŸ  MENÃœ</button>
        </div>
    </div>

    <div id="gameOverScreen" class="screen" style="display: none;">
        <h1>ğŸ’€ OYUN BÄ°TTÄ°</h1>
        <div class="info-box">
            <div style="font-size: 32px; color: #ffd700;">ğŸŒŠ Dalga: <span id="finalWave">0</span></div>
            <div style="font-size: 28px;">ğŸ’¯ Skor: <span id="finalScore">0</span></div>
            <div style="font-size: 24px; color: #4ecdc4;">ğŸ’ KazanÄ±lan: <span id="earnedCrystals">0</span></div>
        </div>
        <div class="info-box">ğŸ† En Ä°yi: Dalga <span id="bestWave">1</span></div>
        <div id="reviveOffer" class="info-box" style="background: rgba(46, 204, 113, 0.2); border: 2px solid #2ecc71;">
            <div style="font-size: 24px; margin-bottom: 15px;">â¤ï¸ DÄ°RÄ°L!</div>
            <div style="font-size: 16px; margin-bottom: 15px;">Reklam izle, devam et!</div>
            <button class="success" onclick="watchAd('revive')">ğŸ“º REKLAM Ä°ZLE</button>
        </div>
        <div class="button-row">
            <button onclick="restartGame()">ğŸ”„ TEKRAR</button>
            <button class="secondary" onclick="backToMenu()">ğŸ  MENÃœ</button>
        </div>
    </div>

    <div id="adScreen" class="screen" style="display: none;">
        <div style="background: rgba(0,0,0,0.9); padding: 40px; border-radius: 20px; text-align: center;">
            <h1>ğŸ“º REKLAM</h1>
            <div style="font-size: 18px; margin: 20px 0; color: #ddd;">Google AdMob reklamÄ± gÃ¶steriliyor...</div>
            <div style="font-size: 48px; color: #ffd700; margin: 20px 0;" id="adTimer">5</div>
            <div style="font-size: 16px; color: #aaa;">LÃ¼tfen bekleyin</div>
        </div>
    </div>

    <div id="ui" style="display: none;">
        <div>ğŸ’¯ <span id="score">0</span></div>
        <div style="font-size: 18px; margin-top: 5px;">â¤ï¸ <span id="health">â¤ï¸â¤ï¸â¤ï¸</span></div>
        <div style="font-size: 16px; margin-top: 5px;">ğŸ’ <span id="gameCrystals">0</span></div>
        <div id="shieldIndicator" style="display: none; margin-top: 5px; font-size: 16px;">ğŸ›¡ï¸ KALKAN AKTÄ°F</div>
    </div>
    <div class="wave-indicator" id="waveIndicator" style="display: none;">ğŸŒŠ <span id="wave">1</span></div>
    <button id="pauseBtn" style="display: none;" onclick="pauseGame()">â¸ï¸</button>
    <button id="musicBtn" style="display: none;" onclick="toggleMusicInGame()">ğŸ”Š</button>
    <canvas id="gameCanvas"></canvas>
    <div class="watermark" id="watermark"></div>

    <script>
    (function () {
        'use strict';

        // --- SECURE STORAGE (base64 encode) - safe wrapper
        window.secureStorage = {
            setItem: (key, value) => { try { localStorage.setItem(btoa(key), btoa(encodeURIComponent(String(value)))); } catch(e){} },
            getItem: (key) => { try { const v = localStorage.getItem(btoa(key)); return v ? decodeURIComponent(atob(v)) : null; } catch(e){ return null; } }
        };

        // safe parse helpers
        const safeInt = (v, d=0) => { const n = parseInt(v); return isNaN(n) ? d : n; };
        const safeJSON = (v, d) => { try { return v ? JSON.parse(v) : d; } catch(e){ return d; } };

        // watermark (dev) - Ã¼retimde kaldÄ±r
        setInterval(() => { document.getElementById('watermark').textContent = `v1.1 | ${new Date().toISOString().slice(11,19)}`; }, 1000);

        // --- AUDIO: ertelenmiÅŸ AudioContext oluÅŸturma (!!! Ã¶nemli)
        let audioCtx = null;
        function ensureAudioContext() {
            if (audioCtx) return audioCtx;
            try {
                const AC = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AC();
            } catch (e) {
                audioCtx = null;
            }
            return audioCtx;
        }

        function playSound(type) {
            if (window.secureStorage.getItem('soundEnabled') === 'false') return;
            const ctx = ensureAudioContext();
            if (!ctx) return;
            if (ctx.state === 'suspended') ctx.resume();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            if (type === 'collect') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                osc.start(); osc.stop(ctx.currentTime + 0.12);
            } else if (type === 'hit') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                osc.start(); osc.stop(ctx.currentTime + 0.22);
            } else if (type === 'powerup') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(400, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(800, ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start(); osc.stop(ctx.currentTime + 0.32);
            }
        }

        function vibrate(ms) {
            if (window.navigator && window.navigator.vibrate && window.secureStorage.getItem('vibrationEnabled') !== 'false') {
                window.navigator.vibrate(ms);
            }
        }

        // --- MÃ¼zik jeneratÃ¶rÃ¼ (basit) ---
        class MusicGenerator {
            constructor() { this.playing = false; this._timeout = null; }
            start() { if (this.playing) return; this.playing = true; this._tick(); }
            stop() { this.playing = false; if (this._timeout) { clearTimeout(this._timeout); this._timeout = null; } }
            toggle() { this.playing ? this.stop() : this.start(); return this.playing; }
            _tick() {
                if (!this.playing) return;
                const ctx = ensureAudioContext();
                if (ctx && ctx.state === 'suspended') ctx.resume();
                if (ctx) {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    const notes = [261.6, 293.6, 329.6, 392.0, 440.0, 523.2];
                    osc.frequency.value = notes[Math.floor(Math.random() * notes.length)];
                    gain.gain.value = 0.05;
                    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.5);
                }
                this._timeout = setTimeout(() => this._tick(), 400);
            }
        }
        const musicGen = new MusicGenerator();

        // --- Oyun verileri (localStorage'tan gÃ¼venli yÃ¼kleme) ---
        const SKINS = {
            classic: {id:'classic', name:'Klasik', icon:'ğŸ”µ', color:'#4ecdc4', price:0, rarity:'common'},
            fire: {id:'fire', name:'AteÅŸ', icon:'ğŸ”¥', color:'#ff4757', price:150, rarity:'rare'},
            shadow: {id:'shadow', name:'GÃ¶lge', icon:'ğŸŒ‘', color:'#2c3e50', price:200, rarity:'epic'},
            gold: {id:'gold', name:'AltÄ±n', icon:'ğŸ‘‘', color:'#ffd700', price:500, rarity:'legendary'}
        };

        let canvas = document.getElementById('gameCanvas');
        let ctx = canvas.getContext('2d');
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // load persisted values safely
        let crystals = safeInt(window.secureStorage.getItem('crystals'), 0);
        let totalCrystalsEarned = safeInt(window.secureStorage.getItem('totalCrystals'), 0);
        let highestWave = safeInt(window.secureStorage.getItem('highestWave'), 1);
        let currentSkin = window.secureStorage.getItem('currentSkin') || 'classic';
        let ownedSkins = safeJSON(window.secureStorage.getItem('ownedSkins'), ['classic']);
        let musicEnabled = window.secureStorage.getItem('musicEnabled') !== 'false';
        let soundEnabled = window.secureStorage.getItem('soundEnabled') !== 'false';
        let vibrationEnabled = window.secureStorage.getItem('vibrationEnabled') !== 'false';
        // purchasedBoosts persisted
        let purchasedBoosts = safeJSON(window.secureStorage.getItem('purchasedBoosts'), { startShield:false, extraLife:false, speedBoost:false, startSlow:false, magnetBoost:false });

        // oyun durum
        let gameState = 'menu';
        let score = 0, health = 3, wave = 1, gameCrystals = 0;
        let player = { x:0, y:0, radius:20, color:'#4ecdc4', speed:6, targetX:0, targetY:0 };
        let enemies = [], stars = [], particles = [];
        let hasShield = false, magnetActive = false;

        // input
        let keys = {};
        document.addEventListener('keydown', e => { keys[e.key.toLowerCase()] = true; });
        document.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });

        // mouse + touch unified (first interaction also ensures AudioContext)
        function pointerSetTarget(x,y) {
            player.targetX = x;
            player.targetY = y;
        }
        canvas.addEventListener('touchstart', e => { e.preventDefault(); ensureAudioContext(); pointerSetTarget(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
        canvas.addEventListener('touchmove', e => { e.preventDefault(); pointerSetTarget(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
        canvas.addEventListener('mousedown', e => { ensureAudioContext(); pointerSetTarget(e.clientX, e.clientY); });
        canvas.addEventListener('mousemove', e => { if (e.buttons) pointerSetTarget(e.clientX, e.clientY); });

        // UI gÃ¼ncelleme
        function updateMainMenuUI() {
            document.getElementById('mainMenuCrystals').textContent = crystals;
            document.getElementById('highestWave').textContent = highestWave;
            document.getElementById('totalCrystals').textContent = totalCrystalsEarned;
            document.getElementById('currentSkinDisplay').textContent = SKINS[currentSkin]?.name || 'Klasik';
        }

        // maÄŸaza
        function openShop() { document.getElementById('startScreen').style.display='none'; document.getElementById('shopScreen').style.display='flex'; document.getElementById('shopCrystals').textContent = crystals; }
        function closeShop() { document.getElementById('shopScreen').style.display='none'; document.getElementById('startScreen').style.display='flex'; updateMainMenuUI(); }
        function switchShopTab(tab) {
            document.getElementById('boostsTab').style.display = tab === 'boosts' ? 'flex' : 'none';
            document.getElementById('skinsTab').style.display = tab === 'skins' ? 'flex' : 'none';
            document.getElementById('tab-boosts').classList.toggle('active', tab === 'boosts');
            document.getElementById('tab-skins').classList.toggle('active', tab === 'skins');
            if(tab === 'skins') renderSkins();
        }
        function renderSkins() {
            const div = document.getElementById('skinsTab'); div.innerHTML = '';
            Object.values(SKINS).forEach(skin => {
                const owned = ownedSkins.includes(skin.id);
                const priceText = owned ? (currentSkin===skin.id ? 'GÄ°YÄ°LÄ°' : 'SAHÄ°P') : 'ğŸ’ '+skin.price;
                const btn = !owned ? `<button onclick="buySkin('${skin.id}', ${skin.price})">AL</button>` :
                    (currentSkin!==skin.id ? `<button class="success" onclick="equipSkin('${skin.id}')">GÄ°Y</button>` : '');
                div.innerHTML += `
                <div class="shop-item" style="border-color:${skin.color}">
                    <div style="font-size:40px">${skin.icon}</div>
                    <div>${skin.name}</div>
                    <div>${priceText}</div>
                    ${btn}
                </div>`;
            });
        }
        function persistPurchasedBoosts() { window.secureStorage.setItem('purchasedBoosts', JSON.stringify(purchasedBoosts)); }

        function buyItem(type, cost) {
            if (type === 'vipPack') {
                if (crystals < cost) { alert('Yetersiz Kristal'); return; }
                crystals -= cost;
                // VIP: grant all boosts + skins
                purchasedBoosts.startShield = true;
                purchasedBoosts.extraLife = true;
                purchasedBoosts.speedBoost = true;
                purchasedBoosts.startSlow = true;
                purchasedBoosts.magnetBoost = true;
                ownedSkins = Array.from(new Set(ownedSkins.concat(['fire','shadow','gold'])));
                window.secureStorage.setItem('ownedSkins', JSON.stringify(ownedSkins));
            } else {
                if (crystals < cost) { alert('Yetersiz Kristal'); return; }
                crystals -= cost;
                purchasedBoosts[type] = true;
            }
            persistPurchasedBoosts();
            window.secureStorage.setItem('crystals', crystals);
            alert('SatÄ±n AlÄ±ndÄ±!');
            openShop();
        }
        function buySkin(id, cost) {
            if(crystals < cost) { alert('Yetersiz Kristal'); return; }
            crystals -= cost;
            ownedSkins.push(id);
            ownedSkins = Array.from(new Set(ownedSkins));
            window.secureStorage.setItem('crystals', crystals);
            window.secureStorage.setItem('ownedSkins', JSON.stringify(ownedSkins));
            renderSkins();
        }
        function equipSkin(id) {
            currentSkin = id;
            window.secureStorage.setItem('currentSkin', id);
            renderSkins();
        }

        // --- Oyun dÃ¶ngÃ¼sÃ¼ ---
        function startGame() {
            gameState = 'playing';
            score = 0;
            health = purchasedBoosts.extraLife ? 4 : 3;
            // boost'larÄ± kullandÄ±ktan sonra temizle (persist)
            purchasedBoosts.extraLife = false;

            wave = 1;
            gameCrystals = 0;
            hasShield = purchasedBoosts.startShield;
            purchasedBoosts.startShield = false;
            magnetActive = purchasedBoosts.magnetBoost;
            purchasedBoosts.magnetBoost = false;

            // speedBoost etki etsin
            if (purchasedBoosts.speedBoost) {
                player.speed = 8;
                purchasedBoosts.speedBoost = false;
            } else player.speed = 6;

            persistPurchasedBoosts();

            player.x = canvas.width/2; player.y = canvas.height/2;
            player.targetX = player.x; player.targetY = player.y;
            player.color = SKINS[currentSkin]?.color || '#4ecdc4';

            enemies = []; stars = []; particles = [];

            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            document.getElementById('gameCanvas').style.display = 'block';
            updateShieldIndicator();

            if (musicEnabled) musicGen.start();
            spawnWave();
            requestAnimationFrame(gameLoop);
        }

        function spawnWave() {
            document.getElementById('wave').textContent = wave;
            document.getElementById('waveIndicator').style.display = 'block';
            setTimeout(() => document.getElementById('waveIndicator').style.display='none', 2000);

            for(let i=0; i<3+wave; i++) {
                enemies.push({
                    x: Math.random() < 0.5 ? -50 : canvas.width+50,
                    y: Math.random()*canvas.height,
                    speed: 2 + (wave*0.2),
                    radius: 15,
                    color: '#ff4757'
                });
            }
            for(let i=0; i<5; i++) createStar();
        }

        function createStar() {
            stars.push({
                x: Math.random()*(canvas.width-100)+50,
                y: Math.random()*(canvas.height-100)+50,
                radius: 10
            });
        }

        function checkCollision(o1, o2) {
            const dx = o1.x - o2.x;
            const dy = o1.y - o2.y;
            return Math.sqrt(dx*dx + dy*dy) < (o1.radius + o2.radius);
        }

        function updateShieldIndicator() {
            const el = document.getElementById('shieldIndicator');
            if (hasShield) { el.style.display = 'block'; } else { el.style.display = 'none'; }
        }

        // oyun dÃ¶ngÃ¼sÃ¼ (gÃ¼venli splice: ters dÃ¶ngÃ¼)
        function gameLoop() {
            if (gameState !== 'playing') return;

            // temizleme (motion trail efekti)
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(0,0, canvas.width, canvas.height);

            // oyuncu hareketi
            const dx = player.targetX - player.x;
            const dy = player.targetY - player.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist > 5) {
                player.x += (dx/dist) * player.speed;
                player.y += (dy/dist) * player.speed;
            }

            // klavye hareketi - hedefi kaydÄ±r
            if(keys['arrowup'] || keys['w']) player.targetY -= 10;
            if(keys['arrowdown'] || keys['s']) player.targetY += 10;
            if(keys['arrowleft'] || keys['a']) player.targetX -= 10;
            if(keys['arrowright'] || keys['d']) player.targetX += 10;

            // sÄ±nÄ±rlar
            player.x = Math.max(player.radius, Math.min(canvas.width - player.radius, player.x));
            player.y = Math.max(player.radius, Math.min(canvas.height - player.radius, player.y));

            // oyuncu Ã§iz
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI*2);
            ctx.fillStyle = player.color;
            ctx.shadowBlur = 20; ctx.shadowColor = player.color;
            ctx.fill();
            if(hasShield) {
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();
            }
            ctx.shadowBlur = 0;

            // yÄ±ldÄ±zlar - ters dÃ¶ngÃ¼ ile splice gÃ¼venli
            for (let i = stars.length - 1; i >= 0; i--) {
                const star = stars[i];
                if (magnetActive) {
                    const sdx = player.x - star.x;
                    const sdy = player.y - star.y;
                    star.x += sdx * 0.05;
                    star.y += sdy * 0.05;
                }
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius, 0, Math.PI*2);
                ctx.fillStyle = '#ffd700';
                ctx.fill();

                if(checkCollision(player, star)) {
                    stars.splice(i, 1);
                    score += 10;
                    gameCrystals++;
                    if (soundEnabled) playSound('collect');
                    createStar();
                    document.getElementById('score').textContent = score;
                    document.getElementById('gameCrystals').textContent = gameCrystals;

                    if(score % 100 === 0) {
                        wave++;
                        spawnWave();
                        if (soundEnabled) playSound('powerup');
                    }
                }
            }

            // dÃ¼ÅŸmanlar - ters dÃ¶ngÃ¼
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                const angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
                enemy.x += Math.cos(angle) * enemy.speed;
                enemy.y += Math.sin(angle) * enemy.speed;

                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, enemy.radius, 0, Math.PI*2);
                ctx.fillStyle = enemy.color;
                ctx.fill();

                if(checkCollision(player, enemy)) {
                    if(hasShield) {
                        hasShield = false;
                        updateShieldIndicator();
                        enemies.splice(i, 1);
                        if (soundEnabled) playSound('hit');
                        vibrate(50);
                    } else {
                        health--;
                        enemies.splice(i, 1);
                        if (soundEnabled) playSound('hit');
                        vibrate(200);
                        document.getElementById('health').textContent = 'â¤ï¸'.repeat(Math.max(0, health));
                        if(health <= 0) {
                            gameOver();
                        }
                    }
                }
            }

            requestAnimationFrame(gameLoop);
        }

        function gameOver() {
            gameState = 'gameover';
            crystals += gameCrystals;
            totalCrystalsEarned += gameCrystals;
            if(wave > highestWave) highestWave = wave;

            window.secureStorage.setItem('crystals', crystals);
            window.secureStorage.setItem('totalCrystals', totalCrystalsEarned);
            window.secureStorage.setItem('highestWave', highestWave);
            window.secureStorage.setItem('ownedSkins', JSON.stringify(ownedSkins));

            document.getElementById('ui').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'flex';
            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalWave').textContent = wave;
            document.getElementById('earnedCrystals').textContent = gameCrystals;
            document.getElementById('bestWave').textContent = highestWave;
            musicGen.stop();
            updateMainMenuUI();
        }

        // basit reklam/watchAd simÃ¼lasyonu
        function watchAd(type) {
            document.getElementById('adTimer').textContent = '5';
            document.getElementById('adScreen').style.display = 'flex';
            let t = 5;
            const iv = setInterval(() => {
                t--;
                document.getElementById('adTimer').textContent = t;
                if (t <= 0) {
                    clearInterval(iv);
                    document.getElementById('adScreen').style.display = 'none';
                    if (type === 'revive') {
                        // revive: oyun durumunu tekrar oynanÄ±r hale getir
                        revivePlayer();
                    } else if (type === 'crystals') {
                        crystals += 50;
                        window.secureStorage.setItem('crystals', crystals);
                        alert('50 kristal kazandÄ±n!');
                        openShop();
                    }
                }
            }, 1000);
        }

        function revivePlayer() {
            if (gameState !== 'gameover') return;
            gameState = 'playing';
            // oyuncuyu hafifÃ§e canlandÄ±r
            health = 1;
            // position reset veya aynÄ± pozisyondan devam et: burada merkezden devam ettir
            player.x = canvas.width/2; player.y = canvas.height/2;
            player.targetX = player.x; player.targetY = player.y;
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            requestAnimationFrame(gameLoop);
        }

        function resumeGame() { // alternatif kullanÄ±m: doÄŸrudan devam et (gameOver revive haric)
            if (gameState === 'paused') {
                gameState = 'playing';
                document.getElementById('pauseScreen').style.display = 'none';
                requestAnimationFrame(gameLoop);
            }
        }

        function restartGame() { startGame(); }
        function backToMenu() { document.getElementById('gameOverScreen').style.display='none'; document.getElementById('startScreen').style.display='flex'; updateMainMenuUI(); }

        // --- Eksik UI fonksiyonlarÄ± eklendi ---
        function openLeaderboard() {
            document.getElementById('startScreen').style.display='none';
            document.getElementById('leaderboardScreen').style.display='flex';
            // Ã¶rnek liste (local olarak)
            const lb = JSON.parse(window.secureStorage.getItem('leaderboard') || '[]');
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '';
            if (lb.length === 0) {
                list.innerHTML = '<div class="info-box">HenÃ¼z liderlik verisi yok.</div>';
            } else {
                lb.sort((a,b) => b.score - a.score).slice(0,50).forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'leaderboard-item';
                    el.innerHTML = `<div>${item.name || 'Anonim'}</div><div>${item.score}</div>`;
                    list.appendChild(el);
                });
            }
        }
        function closeLeaderboard() { document.getElementById('leaderboardScreen').style.display='none'; document.getElementById('startScreen').style.display='flex'; }

        function openSettings() {
            document.getElementById('startScreen').style.display='none';
            document.getElementById('settingsScreen').style.display='flex';
            // toggle gÃ¶rÃ¼nÃ¼mlerini gÃ¼ncelle
            document.getElementById('musicToggle').classList.toggle('active', musicEnabled);
            document.getElementById('soundToggle').classList.toggle('active', soundEnabled);
            document.getElementById('vibrationToggle').classList.toggle('active', vibrationEnabled);
            document.getElementById('totalGames').textContent = window.secureStorage.getItem('totalGames') || '0';
            document.getElementById('totalTime').textContent = window.secureStorage.getItem('totalTime') || '0';
            document.getElementById('totalCrystalsStats').textContent = totalCrystalsEarned || '0';
        }
        function closeSettings() { document.getElementById('settingsScreen').style.display='none'; document.getElementById('startScreen').style.display='flex'; }

        function resetProgress() {
            if (!confirm('Ä°lerlemeni sÄ±fÄ±rlamak istediÄŸine emin misin?')) return;
            window.secureStorage.setItem('crystals', 0);
            window.secureStorage.setItem('totalCrystals', 0);
            window.secureStorage.setItem('highestWave', 1);
            window.secureStorage.setItem('ownedSkins', JSON.stringify(['classic']));
            window.secureStorage.setItem('purchasedBoosts', JSON.stringify({ startShield:false, extraLife:false, speedBoost:false, startSlow:false, magnetBoost:false }));
            // yenile
            crystals = 0; totalCrystalsEarned = 0; highestWave = 1; ownedSkins = ['classic']; purchasedBoosts = { startShield:false, extraLife:false, speedBoost:false, startSlow:false, magnetBoost:false };
            updateMainMenuUI();
            alert('Ä°lerleme sÄ±fÄ±rlandÄ±.');
        }

        function pauseGame() {
            if (gameState === 'playing') {
                gameState = 'paused';
                document.getElementById('pauseWave').textContent = wave;
                document.getElementById('pauseScore').textContent = score;
                document.getElementById('pauseScreen').style.display = 'flex';
                musicGen.stop();
            }
        }
        function resumeFromPause() {
            if (gameState === 'paused') {
                gameState = 'playing';
                document.getElementById('pauseScreen').style.display = 'none';
                if (musicEnabled) musicGen.start();
                requestAnimationFrame(gameLoop);
            }
        }
        function restartFromPause() { document.getElementById('pauseScreen').style.display='none'; startGame(); }
        function quitToMenu() { document.getElementById('pauseScreen').style.display='none'; document.getElementById('ui').style.display='none'; document.getElementById('startScreen').style.display='flex'; gameState='menu'; musicGen.stop(); }

        // ayarlar toggle fonksiyonlarÄ±
        function toggleMusic() { musicEnabled = !musicEnabled; window.secureStorage.setItem('musicEnabled', musicEnabled); document.getElementById('musicToggle').classList.toggle('active', musicEnabled); if (musicEnabled) musicGen.start(); else musicGen.stop(); }
        function toggleSound() { soundEnabled = !soundEnabled; window.secureStorage.setItem('soundEnabled', soundEnabled); document.getElementById('soundToggle').classList.toggle('active', soundEnabled); }
        function toggleVibration() { vibrationEnabled = !vibrationEnabled; window.secureStorage.setItem('vibrationEnabled', vibrationEnabled); document.getElementById('vibrationToggle').classList.toggle('active', vibrationEnabled); }

        function toggleMusicInGame() { toggleMusic(); }

        // yardÄ±mcÄ±lar
        updateMainMenuUI();
        updateShieldIndicator();

        // sayfa ilk tÄ±klamada AudioContext oluÅŸtur ve kullanÄ±cÄ± etkileÅŸimi gerektiÄŸinde tetikle
        ['touchstart','mousedown','keydown'].forEach(evt => {
            window.addEventListener(evt, function f(e) {
                ensureAudioContext();
                window.removeEventListener(evt, f);
            }, {passive:true});
        });

        // window unload persistence minimal
        window.addEventListener('beforeunload', () => {
            window.secureStorage.setItem('crystals', crystals);
            window.secureStorage.setItem('totalCrystals', totalCrystalsEarned);
            window.secureStorage.setItem('highestWave', highestWave);
            window.secureStorage.setItem('ownedSkins', JSON.stringify(ownedSkins));
            window.secureStorage.setItem('purchasedBoosts', JSON.stringify(purchasedBoosts));
        });

    })();
    </script>
</body>
</html>

