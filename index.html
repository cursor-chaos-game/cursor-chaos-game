<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <title>Chaos Runner - Premium Mobile Game</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); touch-action: none; }
        #gameCanvas { display: block; background: rgba(0, 0, 0, 0.3); box-shadow: 0 0 50px rgba(0, 0, 0, 0.5); }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 200; overflow-y: auto; padding: 20px; }
        .screen h1 { font-size: clamp(36px, 8vw, 72px); margin-bottom: 20px; background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #f7b731); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: gradientShift 3s ease infinite; text-align: center; }
        @keyframes gradientShift { 0%, 100% { filter: hue-rotate(0deg); } 50% { filter: hue-rotate(360deg); } }
        .subtitle { font-size: clamp(14px, 2.5vw, 20px); margin-bottom: 25px; color: #aaa; text-align: center; }
        .info-box { background: rgba(255, 255, 255, 0.1); padding: 15px 25px; margin: 8px 0; border-radius: 12px; backdrop-filter: blur(10px); font-size: clamp(14px, 2.5vw, 18px); max-width: 90%; text-align: center; }
        button { margin: 10px; padding: 15px 40px; font-size: clamp(16px, 3.5vw, 24px); font-weight: bold; color: white; background: linear-gradient(45deg, #ff6b6b, #ee5a6f); border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4); transition: all 0.3s ease; text-transform: uppercase; min-width: 180px; }
        button:active { transform: scale(0.95); }
        button.secondary { background: linear-gradient(45deg, #4ecdc4, #45b7d1); box-shadow: 0 8px 25px rgba(78, 205, 196, 0.4); }
        button.success { background: linear-gradient(45deg, #2ecc71, #27ae60); box-shadow: 0 8px 25px rgba(46, 204, 113, 0.4); }
        button.premium { background: linear-gradient(45deg, #f7b731, #f39c12); box-shadow: 0 8px 25px rgba(247, 183, 49, 0.6); animation: premiumGlow 2s ease-in-out infinite; }
        @keyframes premiumGlow { 0%, 100% { box-shadow: 0 8px 25px rgba(247, 183, 49, 0.6); } 50% { box-shadow: 0 8px 35px rgba(247, 183, 49, 0.9); } }
        .button-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        #ui { position: fixed; top: 10px; left: 10px; color: white; font-size: clamp(16px, 3vw, 24px); text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); z-index: 100; user-select: none; }
        #score { font-size: clamp(24px, 5vw, 36px); font-weight: bold; color: #ffd700; }
        .wave-indicator { position: fixed; top: 10px; right: 10px; font-size: clamp(18px, 4vw, 28px); color: white; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); padding: 12px 20px; background: rgba(0, 0, 0, 0.6); border-radius: 15px; backdrop-filter: blur(10px); }
        #pauseBtn, #musicBtn { position: fixed; width: 50px; height: 50px; min-width: unset; padding: 10px; font-size: 24px; z-index: 101; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        #pauseBtn { top: 10px; right: 10px; }
        #musicBtn { top: 70px; right: 10px; }
        .shop-item { background: rgba(255, 255, 255, 0.1); padding: 20px; margin: 10px; border-radius: 15px; border: 3px solid rgba(255, 255, 255, 0.3); width: 280px; text-align: center; transition: all 0.3s ease; }
        .shop-item.premium-item { border-color: #f7b731; background: linear-gradient(135deg, rgba(247, 183, 49, 0.2), rgba(243, 156, 18, 0.2)); box-shadow: 0 0 20px rgba(247, 183, 49, 0.3); }
        .shop-item-icon { font-size: 64px; margin-bottom: 15px; filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5)); }
        .shop-items-grid { display: flex; flex-wrap: wrap; justify-content: center; max-width: 95%; max-height: 65vh; overflow-y: auto; }
        .skin-preview { width: 80px; height: 80px; margin: 10px auto; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px; border: 3px solid rgba(255, 255, 255, 0.3); background: rgba(0, 0, 0, 0.3); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 12px 24px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 25px; cursor: pointer; transition: all 0.3s; }
        .tab.active { background: linear-gradient(45deg, #4ecdc4, #45b7d1); border-color: #4ecdc4; }
        .leaderboard-item { background: rgba(255, 255, 255, 0.1); padding: 15px 20px; margin: 8px 0; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; width: 90%; max-width: 500px; }
        .settings-option { background: rgba(255, 255, 255, 0.1); padding: 20px; margin: 10px 0; border-radius: 12px; width: 90%; max-width: 400px; display: flex; justify-content: space-between; align-items: center; }
        .toggle-switch { width: 60px; height: 30px; background: #555; border-radius: 15px; position: relative; cursor: pointer; transition: all 0.3s; }
        .toggle-switch.active { background: #2ecc71; }
        .toggle-switch::after { content: ''; position: absolute; width: 26px; height: 26px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: all 0.3s; }
        .toggle-switch.active::after { left: 32px; }
        @media (max-width: 768px) { .shop-item { width: 90%; } }
        .watermark { position: fixed; bottom: 5px; right: 5px; font-size: 8px; color: rgba(255, 255, 255, 0.1); pointer-events: none; user-select: none; z-index: 9999; }
    </style>
</head>
<body>
    <div id="startScreen" class="screen">
        <h1>ğŸ® CHAOS RUNNER</h1>
        <div class="subtitle">KaranlÄ±ktan KaÃ§, IÅŸÄ±ÄŸÄ± Bul</div>
        <div class="info-box">ğŸ’ <span id="mainMenuCrystals">0</span> Kristal</div>
        <div class="button-row">
            <button onclick="startGame()">ğŸ® OYNA</button>
            <button class="secondary" onclick="openShop()">ğŸ›’ MAÄAZA</button>
        </div>
        <div class="button-row">
            <button class="secondary" onclick="openLeaderboard()">ğŸ† LIDERLER</button>
            <button class="secondary" onclick="openSettings()">âš™ï¸ AYARLAR</button>
        </div>
        <div class="info-box" style="margin-top: 20px;">
            <div>ğŸ† En YÃ¼ksek Dalga: <span id="highestWave">1</span></div>
            <div>ğŸ’° Toplam KazanÃ§: <span id="totalCrystals">0</span></div>
            <div style="margin-top: 10px; font-size: 14px; color: #888;">KostÃ¼m: <span id="currentSkinDisplay">ğŸ”µ Klasik</span></div>
        </div>
    </div>

    <div id="shopScreen" class="screen" style="display: none;">
        <h1>ğŸ›’ MAÄAZA</h1>
        <div style="font-size: 24px; margin-bottom: 20px;">ğŸ’ <span id="shopCrystals">0</span> Kristal</div>
        <div class="tabs">
            <div class="tab active" onclick="switchShopTab('boosts')">âš¡ GÃ¼Ã§ler</div>
            <div class="tab" onclick="switchShopTab('skins')">ğŸ¨ KostÃ¼mler</div>
        </div>
        <div id="boostsTab" class="shop-items-grid">
            <div class="shop-item"><div class="shop-item-icon">ğŸ›¡ï¸</div><div class="shop-item-name">BaÅŸlangÄ±Ã§ KalkanÄ±</div><div class="shop-item-desc">Oyuna kalkan ile baÅŸla</div><div class="shop-item-price">ğŸ’ 50</div><button onclick="buyItem('startShield', 50)">SATIN AL</button></div>
            <div class="shop-item"><div class="shop-item-icon">â¤ï¸</div><div class="shop-item-name">Ekstra Can</div><div class="shop-item-desc">+1 can ile baÅŸla</div><div class="shop-item-price">ğŸ’ 75</div><button onclick="buyItem('extraLife', 75)">SATIN AL</button></div>
            <div class="shop-item"><div class="shop-item-icon">âš¡</div><div class="shop-item-name">HÄ±z ArtÄ±ÅŸÄ±</div><div class="shop-item-desc">%30 daha hÄ±zlÄ± koÅŸ</div><div class="shop-item-price">ğŸ’ 100</div><button onclick="buyItem('speedBoost', 100)">SATIN AL</button></div>
            <div class="shop-item"><div class="shop-item-icon">ğŸ•</div><div class="shop-item-name">Zaman KontrolÃ¼</div><div class="shop-item-desc">Ä°lk 10 saniye dÃ¼ÅŸman yavaÅŸ</div><div class="shop-item-price">ğŸ’ 80</div><button onclick="buyItem('startSlow', 80)">SATIN AL</button></div>
            <div class="shop-item"><div class="shop-item-icon">ğŸ§²</div><div class="shop-item-name">Kristal MÄ±knatÄ±sÄ±</div><div class="shop-item-desc">Otomatik toplama</div><div class="shop-item-price">ğŸ’ 120</div><button onclick="buyItem('magnetBoost', 120)">SATIN AL</button></div>
            <div class="shop-item premium-item"><div class="premium-badge">â­ PREMIUM</div><div class="shop-item-icon">ğŸ‘‘</div><div class="shop-item-name">VIP Paketi</div><div class="shop-item-desc">TÃ¼m gÃ¼Ã§ler + 3 premium kostÃ¼m</div><div class="shop-item-price">ğŸ’ 500</div><button class="premium" onclick="buyItem('vipPack', 500)">PREMIUM AL</button></div>
            <div class="shop-item" style="border-color: #2ecc71;"><div class="shop-item-icon">ğŸ“º</div><div class="shop-item-name">Ãœcretsiz Kristal</div><div class="shop-item-desc">Reklam izle, 50 kristal kazan</div><div class="shop-item-price">ğŸ ÃœCRETSÄ°Z</div><button class="success" onclick="watchAd('crystals')">Ä°ZLE</button></div>
        </div>
        <div id="skinsTab" class="shop-items-grid" style="display: none;"></div>
        <button class="secondary" onclick="closeShop()" style="margin-top: 20px;">â—€ GERÄ°</button>
    </div>

    <div id="leaderboardScreen" class="screen" style="display: none;">
        <h1>ğŸ† LÄ°DERLÄ°K TABLOSU</h1>
        <div class="subtitle">En Ä°yi Oyuncular</div>
        <div id="leaderboardList" style="width: 100%; display: flex; flex-direction: column; align-items: center; max-height: 60vh; overflow-y: auto;"></div>
        <button class="secondary" onclick="closeLeaderboard()" style="margin-top: 20px;">â—€ GERÄ°</button>
    </div>

    <div id="settingsScreen" class="screen" style="display: none;">
        <h1>âš™ï¸ AYARLAR</h1>
        <div class="settings-option"><span>ğŸ”Š MÃ¼zik</span><div class="toggle-switch" id="musicToggle" onclick="toggleMusic()"></div></div>
        <div class="settings-option"><span>ğŸ”” Ses Efektleri</span><div class="toggle-switch active" id="soundToggle" onclick="toggleSound()"></div></div>
        <div class="settings-option"><span>ğŸ“³ TitreÅŸim</span><div class="toggle-switch active" id="vibrationToggle" onclick="toggleVibration()"></div></div>
        <div class="info-box" style="margin-top: 30px;">
            <div style="font-size: 16px; margin-bottom: 15px;">ğŸ“Š Ä°STATÄ°STÄ°KLER</div>
            <div>ğŸ® Toplam Oyun: <span id="totalGames">0</span></div>
            <div>â±ï¸ Toplam SÃ¼re: <span id="totalTime">0</span> dk</div>
            <div>ğŸ’ Toplam Kristal: <span id="totalCrystalsStats">0</span></div>
        </div>
        <button onclick="resetProgress()" style="background: linear-gradient(45deg, #e74c3c, #c0392b); margin-top: 20px;">ğŸ—‘ï¸ Ä°LERLEMEYÄ° SIL</button>
        <button class="secondary" onclick="closeSettings()" style="margin-top: 10px;">â—€ GERÄ°</button>
    </div>

    <div id="pauseScreen" class="screen" style="display: none;">
        <h1>â¸ï¸ DURAKLAMA</h1>
        <div class="info-box"><div>ğŸŒŠ Dalga: <span id="pauseWave">1</span></div><div>ğŸ’¯ Skor: <span id="pauseScore">0</span></div></div>
        <div class="button-row">
            <button class="success" onclick="resumeGame()">â–¶ï¸ DEVAM</button>
            <button class="secondary" onclick="restartFromPause()">ğŸ”„ YENÄ°DEN</button>
            <button onclick="quitToMenu()">ğŸ  MENÃœ</button>
        </div>
    </div>

    <div id="gameOverScreen" class="screen" style="display: none;">
        <h1>ğŸ’€ OYUN BÄ°TTÄ°</h1>
        <div class="info-box">
            <div style="font-size: 32px; color: #ffd700;">ğŸŒŠ Dalga: <span id="finalWave">0</span></div>
            <div style="font-size: 28px;">ğŸ’¯ Skor: <span id="finalScore">0</span></div>
            <div style="font-size: 24px; color: #4ecdc4;">ğŸ’ KazanÄ±lan: <span id="earnedCrystals">0</span></div>
        </div>
        <div class="info-box">ğŸ† En Ä°yi: Dalga <span id="bestWave">1</span></div>
        <div id="reviveOffer" class="info-box" style="background: rgba(46, 204, 113, 0.2); border: 2px solid #2ecc71;">
            <div style="font-size: 24px; margin-bottom: 15px;">â¤ï¸ DÄ°RÄ°L!</div>
            <div style="font-size: 16px; margin-bottom: 15px;">Reklam izle, devam et!</div>
            <button class="success" onclick="watchAd('revive')">ğŸ“º REKLAM Ä°ZLE</button>
        </div>
        <div class="button-row">
            <button onclick="restartGame()">ğŸ”„ TEKRAR</button>
            <button class="secondary" onclick="backToMenu()">ğŸ  MENÃœ</button>
        </div>
    </div>

    <div id="adScreen" class="screen" style="display: none;">
        <div style="background: rgba(0,0,0,0.9); padding: 40px; border-radius: 20px; text-align: center;">
            <h1>ğŸ“º REKLAM</h1>
            <div style="font-size: 18px; margin: 20px 0; color: #ddd;">Google AdMob reklamÄ± gÃ¶steriliyor...</div>
            <div style="font-size: 48px; color: #ffd700; margin: 20px 0;" id="adTimer">5</div>
            <div style="font-size: 16px; color: #aaa;">LÃ¼tfen bekleyin</div>
        </div>
    </div>

    <div id="ui" style="display: none;">
        <div>ğŸ’¯ <span id="score">0</span></div>
        <div style="font-size: 18px; margin-top: 5px;">â¤ï¸ <span id="health">â¤ï¸â¤ï¸â¤ï¸</span></div>
        <div style="font-size: 16px; margin-top: 5px;">ğŸ’ <span id="gameCrystals">0</span></div>
        <div id="shieldIndicator" style="display: none; margin-top: 5px; font-size: 16px;">ğŸ›¡ï¸ KALKAN AKTÄ°F</div>
    </div>
    <div class="wave-indicator" id="waveIndicator" style="display: none;">ğŸŒŠ <span id="wave">1</span></div>
    <button id="pauseBtn" style="display: none;" onclick="pauseGame()">â¸ï¸</button>
    <button id="musicBtn" style="display: none;" onclick="toggleMusicInGame()">ğŸ”Š</button>
    <canvas id="gameCanvas"></canvas>
    <div class="watermark" id="watermark"></div>

    <script>
        // ğŸ”’ GÃœVENLÄ°K VE ALTYAPI
        (function() {
            'use strict';
            window.secureStorage = {
                setItem: (key, value) => { try { localStorage.setItem(btoa(key), btoa(encodeURIComponent(value))); } catch(e){} },
                getItem: (key) => { try { const v = localStorage.getItem(btoa(key)); return v ? decodeURIComponent(atob(v)) : null; } catch(e){ return null; } }
            };
            window.validateGameState = () => {
                let cr = parseInt(window.secureStorage.getItem('crystals') || '0');
                if (cr > 999999) window.secureStorage.setItem('crystals', '0');
            };
            setInterval(() => document.getElementById('watermark').textContent = `v1.0 | ${Date.now()}`, 1000);
        })();

        // ğŸµ SES EFEKTÄ° SÄ°STEMÄ° (EKSÄ°KTÄ°, EKLENDÄ°)
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        
        function playSound(type) {
            if (window.secureStorage.getItem('soundEnabled') === 'false') return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            if (type === 'collect') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'hit') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                osc.start(); osc.stop(audioCtx.currentTime + 0.2);
            } else if (type === 'powerup') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(800, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        function vibrate(ms) {
            if (window.navigator && window.navigator.vibrate && window.secureStorage.getItem('vibrationEnabled') !== 'false') {
                window.navigator.vibrate(ms);
            }
        }

        // ğŸµ MÃœZÄ°K SÄ°STEMÄ°
        class MusicGenerator {
            constructor() { this.playing = false; }
            start() { this.playing = true; this.playNote(); }
            stop() { this.playing = false; }
            toggle() { this.playing = !this.playing; if(this.playing) this.start(); return this.playing; }
            playNote() {
                if (!this.playing) return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                const notes = [261.6, 293.6, 329.6, 392.0, 440.0, 523.2];
                osc.frequency.value = notes[Math.floor(Math.random() * notes.length)];
                gain.gain.value = 0.05;
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.5);
                setTimeout(() => this.playNote(), 400);
            }
        }
        const musicGen = new MusicGenerator();

        // DEÄÄ°ÅKENLER
        const SKINS = {
            classic: {id:'classic', name:'Klasik', icon:'ğŸ”µ', color:'#4ecdc4', price:0, rarity:'common'},
            fire: {id:'fire', name:'AteÅŸ', icon:'ğŸ”¥', color:'#ff4757', price:150, rarity:'rare'},
            shadow: {id:'shadow', name:'GÃ¶lge', icon:'ğŸŒ‘', color:'#2c3e50', price:200, rarity:'epic'},
            gold: {id:'gold', name:'AltÄ±n', icon:'ğŸ‘‘', color:'#ffd700', price:500, rarity:'legendary'}
        };
        
        let canvas = document.getElementById('gameCanvas');
        let ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let gameState = 'menu';
        let score = 0, health = 3, wave = 1, gameCrystals = 0;
        let crystals = parseInt(window.secureStorage.getItem('crystals') || '0');
        let totalCrystalsEarned = parseInt(window.secureStorage.getItem('totalCrystals') || '0');
        let highestWave = parseInt(window.secureStorage.getItem('highestWave') || '1');
        let currentSkin = window.secureStorage.getItem('currentSkin') || 'classic';
        let ownedSkins = JSON.parse(window.secureStorage.getItem('ownedSkins') || '["classic"]');
        let musicEnabled = window.secureStorage.getItem('musicEnabled') !== 'false';
        
        let player = { x:0, y:0, radius:20, color:'#4ecdc4', speed:6, targetX:0, targetY:0 };
        let enemies = [], stars = [], particles = [];
        let purchasedBoosts = { startShield:false, extraLife:false, speedBoost:false, startSlow:false, magnetBoost:false };
        let hasShield = false;
        let magnetActive = false;
        
        // KONTROLLER
        let keys = {};
        document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
        document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
        
        canvas.addEventListener('touchstart', e => { e.preventDefault(); player.targetX = e.touches[0].clientX; player.targetY = e.touches[0].clientY; }, {passive:false});
        canvas.addEventListener('touchmove', e => { e.preventDefault(); player.targetX = e.touches[0].clientX; player.targetY = e.touches[0].clientY; }, {passive:false});

        // UI UPDATE
        function updateMainMenuUI() {
            document.getElementById('mainMenuCrystals').textContent = crystals;
            document.getElementById('highestWave').textContent = highestWave;
            document.getElementById('totalCrystals').textContent = totalCrystalsEarned;
            document.getElementById('currentSkinDisplay').textContent = SKINS[currentSkin].name;
        }

        // MAÄAZA Ä°ÅLEMLERÄ°
        function openShop() { document.getElementById('startScreen').style.display='none'; document.getElementById('shopScreen').style.display='flex'; document.getElementById('shopCrystals').textContent = crystals; }
        function closeShop() { document.getElementById('shopScreen').style.display='none'; document.getElementById('startScreen').style.display='flex'; }
        function switchShopTab(tab) {
            document.getElementById('boostsTab').style.display = tab === 'boosts' ? 'flex' : 'none';
            document.getElementById('skinsTab').style.display = tab === 'skins' ? 'flex' : 'none';
            if(tab === 'skins') renderSkins();
        }
        function renderSkins() {
            const div = document.getElementById('skinsTab'); div.innerHTML = '';
            Object.values(SKINS).forEach(skin => {
                const owned = ownedSkins.includes(skin.id);
                div.innerHTML += `
                <div class="shop-item" style="border-color:${skin.color}">
                    <div style="font-size:40px">${skin.icon}</div>
                    <div>${skin.name}</div>
                    <div>${owned ? (currentSkin===skin.id ? 'GÄ°YÄ°LÄ°' : 'SAHÄ°P') : 'ğŸ’ '+skin.price}</div>
                    ${!owned ? `<button onclick="buySkin('${skin.id}', ${skin.price})">AL</button>` : 
                      (currentSkin!==skin.id ? `<button class="success" onclick="equipSkin('${skin.id}')">GÄ°Y</button>` : '')}
                </div>`;
            });
        }
        function buyItem(type, cost) {
            if(crystals < cost) { alert('Yetersiz Kristal'); return; }
            crystals -= cost;
            purchasedBoosts[type] = true;
            window.secureStorage.setItem('crystals', crystals);
            alert('SatÄ±n AlÄ±ndÄ±!');
            openShop();
        }
        function buySkin(id, cost) {
            if(crystals < cost) { alert('Yetersiz Kristal'); return; }
            crystals -= cost;
            ownedSkins.push(id);
            window.secureStorage.setItem('crystals', crystals);
            window.secureStorage.setItem('ownedSkins', JSON.stringify(ownedSkins));
            renderSkins();
        }
        function equipSkin(id) {
            currentSkin = id;
            window.secureStorage.setItem('currentSkin', id);
            renderSkins();
        }

        // OYUN DÃ–NGÃœSÃœ VE MANTIK
        function startGame() {
            gameState = 'playing';
            score = 0;
            health = purchasedBoosts.extraLife ? 4 : 3;
            purchasedBoosts.extraLife = false;
            wave = 1;
            gameCrystals = 0;
            hasShield = purchasedBoosts.startShield;
            purchasedBoosts.startShield = false;
            magnetActive = purchasedBoosts.magnetBoost;
            purchasedBoosts.magnetBoost = false;
            
            player.speed = purchasedBoosts.speedBoost ? 8 : 6;
            purchasedBoosts.speedBoost = false;

            player.x = canvas.width/2; player.y = canvas.height/2;
            player.targetX = player.x; player.targetY = player.y;
            player.color = SKINS[currentSkin].color;
            
            enemies = []; stars = []; particles = [];
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            document.getElementById('gameCanvas').style.display = 'block';
            
            if(musicEnabled) musicGen.start();
            spawnWave();
            requestAnimationFrame(gameLoop);
        }

        function spawnWave() {
            document.getElementById('wave').textContent = wave;
            document.getElementById('waveIndicator').style.display = 'block';
            setTimeout(() => document.getElementById('waveIndicator').style.display='none', 2000);
            
            for(let i=0; i<3+wave; i++) {
                enemies.push({
                    x: Math.random() < 0.5 ? -50 : canvas.width+50,
                    y: Math.random()*canvas.height,
                    speed: 2 + (wave*0.2),
                    radius: 15,
                    color: '#ff4757'
                });
            }
            for(let i=0; i<5; i++) createStar();
        }

        function createStar() {
            stars.push({
                x: Math.random()*(canvas.width-100)+50,
                y: Math.random()*(canvas.height-100)+50,
                radius: 10
            });
        }

        function checkCollision(o1, o2) {
            const dx = o1.x - o2.x;
            const dy = o1.y - o2.y;
            return Math.sqrt(dx*dx + dy*dy) < (o1.radius + o2.radius);
        }

        function gameLoop() {
            if(gameState !== 'playing') return;

            // 1. Temizle
            ctx.fillStyle = 'rgba(0,0,0,0.2)'; // Hareket izi efekti
            ctx.fillRect(0,0, canvas.width, canvas.height);

            // 2. Oyuncu Hareketi (Mouse/Touch yumuÅŸak takip)
            const dx = player.targetX - player.x;
            const dy = player.targetY - player.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            if(dist > 5) {
                player.x += (dx/dist) * player.speed;
                player.y += (dy/dist) * player.speed;
            }

            // Klavye desteÄŸi
            if(keys.arrowup || keys.w) player.targetY -= 10;
            if(keys.arrowdown || keys.s) player.targetY += 10;
            if(keys.arrowleft || keys.a) player.targetX -= 10;
            if(keys.arrowright || keys.d) player.targetX += 10;

            // Oyuncu Ã‡iz
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI*2);
            ctx.fillStyle = player.color;
            ctx.shadowBlur = 20; ctx.shadowColor = player.color;
            ctx.fill();
            if(hasShield) {
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();
            }
            ctx.shadowBlur = 0;

            // 3. YÄ±ldÄ±zlar
            stars.forEach((star, index) => {
                // MÄ±knatÄ±s mant
